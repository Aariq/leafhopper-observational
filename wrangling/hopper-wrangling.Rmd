---
title: "Leafhopper data wrangling"
author: "Eric R. Scott"
date: "2019-11-5"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

*Last compiled: `r Sys.Date()`*

```{r packages, message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(lubridate)
library(conflicted)
conflict_prefer("filter", "dplyr")
conflict_prefer("lag", "dplyr")
conflict_prefer("here", "here")
```

# Purpose

Create a dataframe for analyzing leafhopper density as a function of weather.

# Read in data

```{r}
hoppers <- read_rds(here("data", "cleaned", "hoppers.rds"))
daily.temps <- read_rds(here("data", "cleaned", "daily-temps-hobo.rds"))
hourly.temps <- read_rds(here("data", "cleaned", "hourly-temps-hobo.rds"))
caas <- read_rds(here("data", "cleaned", "weather-caas.rds"))
rain_gauge <- read_rds(here("data", "cleaned", "rain-gauge.rds"))
```


# Join temperature data

Join temperature summary data.  Previously, I lagged the weather data, but that's just confusing at this point.  I'm not going to do that, I think.

```{r}
hoppers2 <- 
  inner_join(hoppers, daily.temps, by = "date")
hoppers2
```

Find temperature at time of Count.Dtime (the time when leafhopper counts started).

```{r find temp at time of counting}
hourly <-
  hourly.temps %>%
  select(-date) %>% 
  #create a column of times rounded to the nearest hour
  mutate(rounded = round_date(date_time, unit = "hour"))

hoppers3 <-
  hoppers2 %>% 
  mutate(rounded = round_date(date_time, unit = "hour"))

#join and clean up columns used only for joining
hoppers4 <-
  left_join(hoppers3, hourly, by = "rounded") %>% 
  select(-rounded, -date_time.y) %>% 
  rename(date_time = date_time.x,
         temp_at_count = temp_c)

hoppers4
```
# Join some of the caas data
```{r}
caas_subset <-
  caas %>% 
  select(date,
         temp_mean_caas,
         precip_caas_mm = precip_caas_0.1mm,
         sun_hrs,
         rh) %>% 
  mutate(date = as_date(date))

hopper_weather1 <- left_join(hoppers4, caas_subset, by = "date")
```

# Join rain gauge data

```{r}
hopper_weather2 <- left_join(hopper_weather1, rain_gauge, by = "date")
```

# Is the CAAS data useful?
No, probably not :-(
```{r}
ggplot(hopper_weather2, aes(x = precip_mm, y = precip_caas_mm)) + geom_point()
```
```{r}
ggplot(hopper_weather2, aes(x = date)) +
  geom_line(aes(y = precip_mm), color = "blue") +
  geom_line(aes(y = precip_caas_mm), color = "green")
```

Temperature data is extremely similar, so that's good.  Rainfall is patchy.

```{r}
ggplot(hopper_weather2, aes(x = date)) +
  geom_line(aes(y = temp_mean), color = "red") +
  geom_line(aes(y = temp_mean_caas), color = "orange")
```

```{r}
hopper_weather3 <- hopper_weather2 %>% select(-temp_mean_caas)
```



# Write to file

```{r save hopper data}
write_rds(hopper_weather3, here("data", "cleaned", "hopper-weather.rds"))
```





