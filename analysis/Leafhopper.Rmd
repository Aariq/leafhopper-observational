---
title: "Leafhopper population growth analysis"
output: html_notebook
---

# Leafhopper density over time

I've collected `r max(hopper.data$date.post)` days of data on leafhopper density this summer. Each day consists of counts of leafhoppers (per some number of leaves) on 20 plants in 2 fields (10 plants in each field) My main goal for this analysis is to determine if there is a relationship between leafhopper growth rate and temperature, but I'm also interested in the effects of precipitation and harvesting.

**To Do:**
 - model growth rate rather than counts?? RGR = ln(n2 − n1)/t2 − t1) [from Robinson et al, 2017]
 - ALL THE MODELING
 
```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(broom)
library(lubridate)
```

## Read in data
```{r}
#input <- readRDS("hopper data.rds")
hopper.data.full <- read_rds("hopper data.rds")
```

The `hopper.data.full` object contains the following columns:

 - `Date`, the date of harvest
 - `Field`, there are two adjacent fields we are measuring growing identical cultivars, but on opposite sides of a hill
 - `Start.Time`, the time we started our counts for that field on that day
 - `Harvesting`, was this the day after a harvest?
 - `Plant`, I marked 10 plants in each field
 - `hoppers`, number of leafhoppers counted
 - `number of leaves`, part way through the summer, we increased our sampling effort.  It's either 30 or 60 leaves
 - `counter`, the first initial of the person doing the counting on that particular plant.
 - `date.post`, this is just the days in a simple numeric format
 - `date.temp`, this is the date the mean, min and max temperature measurements correspond to.
 - `mean, min, and max.temp`, temperature data for the day previous to these counts.
 - `count.temp`, the temperature at the time of counting

## Data exploration

Calculate density
```{r}
hopper.data.full <- hopper.data.full %>%
  mutate(density = hoppers/num.leaves,
         ID = paste0(Field, Plant))
hopper.data.full
```

### Summary statistics
```{r}
SEM <- function(x){
  sd(x)/sqrt(length(x))
}

hopper.data.full %>% 
  summarize(Days = length(unique(Date)),
            Max.Temp = round(max(max.temp), 2),
            Min.Temp = round(min(min.temp), 2),
            Mean.Temp = paste(round(mean(mean.temp), 2), "±", round(sd(mean.temp), 2)),
            Mean.Density = paste(round(mean(density), 4), "±", round(sd(density), 4)))

hopper.data.full %>% 
  group_by(Field, Date) %>%
  summarize(Mean.Density = mean(density)) %>%
  ungroup() %>% 
  group_by(Field) %>% 
  summarize(Mean.Density2 = mean(Mean.Density), sd = sd(Mean.Density))
```


### Visualize leafhopper counts/densities over time

I should create a plot with a mean count (or a mean count per field) with individual plants underlaid in grey (or low alpha).

Get Harvest Dates
```{r}
#hopper.data.full
harvest.dates.A <- hopper.data.full %>% 
  group_by(Field, Date) %>% 
  summarize(Harvest = last(Harvesting)) %>% 
  filter(Harvest == "Y", Field == "A") %>% 
  ungroup() %>% 
  dplyr::select(Date)

harvest.dates.B <- hopper.data.full %>% 
  group_by(Field, Date) %>% 
  summarize(Harvest = last(Harvesting)) %>% 
  filter(Harvest == "Y", Field == "B") %>% 
  ungroup() %>% 
  dplyr::select(Date)

harvest.dates.B <- c(harvest.dates.B$Date, max(hopper.data.full$Date))
#on the last day of data collection field B was harvested

```


```{r}
densityplot <- ggplot(hopper.data.full, aes(x = Date, y = density)) +
  geom_line(aes(group = ID, color = Field), alpha = .18) +
  stat_summary(fun.y = "mean", geom = "line", size = 1, aes(color = Field)) +
  scale_x_date(date_breaks = "weeks", date_labels = "%b %d") +
  theme_bw() +
  ggtitle("Leafhopper density over time on individual plants", "field-level means in bold") +
  labs(y = "density (insects/leaf)", x = "Date")

densityplot +
  geom_vline(xintercept = as.numeric(unlist(harvest.dates.A)), color = "red", linetype = 4) +
  geom_vline(xintercept = as.numeric(unlist(harvest.dates.B)), color = "turquoise4", linetype = 4)

# densityplot +
#   geom_segment(aes(x = harvest.dates.A, xend = harvest.dates.A, y = -0.01, yend = 0),
#                linetype = 1,
#                lwd = 0.3,
#                color = "red",
#                arrow = arrow(length = unit(0.3, "cm"),type = "open", angle = 20))
#   
  
#ggsave("density vs time.png")
```



### Visualize leafhopper counts vs. temperature

Similar plot, but vs. temperature.
```{r, eval=FALSE, include=FALSE}
ggplot(hopper.data.full, aes(x = mean.temp, y = density)) +
  geom_point(aes(group = ID, color = Field)) +
  theme_bw() +
  ggtitle("Leafhopper density by mean daily temperature of previous day")
```

#### Preliminary modeling
Gonna need to do some modeling to put in any useful information I think.  Not going to bother with random effects for now (counter, temp at time of counting, etc.)
```{r}
m.quad.A <- glm(hoppers ~ mean.temp + I(mean.temp*mean.temp),
                family = poisson(link = "log"),
                offset = log(num.leaves),
                data = filter(hopper.data.full, Field == "A"))

m.lin.A <- glm(hoppers ~ mean.temp,
               family = poisson(link = "log"),
               offset = log(num.leaves),
               data = filter(hopper.data.full, Field == "A"))

m.null.A <- glm(hoppers ~ 1,
                family = poisson(link = "log"),
                offset = log(num.leaves),
                data = filter(hopper.data.full, Field == "A"))

AIC(m.quad.A, m.lin.A, m.null.A)

m.quad.B <- glm(hoppers ~ mean.temp + I(mean.temp*mean.temp),
                family = poisson(link = "log"),
                offset = log(num.leaves),
                data = filter(hopper.data.full, Field == "B"))

m.lin.B <- glm(hoppers ~ mean.temp,
               family = poisson(link = "log"),
               offset = log(num.leaves),
               data = filter(hopper.data.full, Field == "B"))

m.null.B <- glm(hoppers ~ 1,
                family = poisson(link = "log"),
                offset = log(num.leaves),
                data = filter(hopper.data.full, Field == "B"))
AIC(m.quad.B, m.lin.B, m.null.B)

```
Quadratic wins!


```{r, message=FALSE, warning=FALSE}
# You have to use the newdata arguement in predict or it doesn't take offset
# into account.  Telling it num.leaves = 1 makes it give you a predicted value
# per 1 leaf (i.e. a density)
model.temp <- seq(min(hopper.data.full$mean.temp), max(hopper.data.full$mean.temp), length.out = 1000)

output.A <- predict(m.quad.A, newdata = data.frame(mean.temp = model.temp, num.leaves = 1), type = "response", se.fit = TRUE)
output.B <- predict(m.quad.B, newdata = data.frame(mean.temp = model.temp, num.leaves = 1), type = "response", se.fit = TRUE)


ggplot(hopper.data.full) +
  geom_point(aes(x = mean.temp, y = density, color = Field)) +
  geom_line(aes(x = model.temp, y = output.A$fit), color = "red") +
  geom_line(aes(x = model.temp, y = output.B$fit), color = "turquoise4") +
  geom_ribbon(aes(x = model.temp,
                  ymin = output.A$fit - 1.96*output.A$se.fit,
                  ymax = output.A$fit + 1.96*output.A$se.fit), alpha = 0.25) +
  geom_ribbon(aes(x = model.temp,
                  ymin = output.B$fit - 1.96*output.B$se.fit,
                  ymax = output.B$fit + 1.96*output.B$se.fit), alpha = 0.25) +
  ggtitle("Response of leafhopper density to mean daily temperature", "Quadratic model wins at ∆AIC") +
  labs(x = "mean daily temperature (ºC)", y = "leafhopper density (insects/leaf)") +
  theme_bw()
ggsave("density vs temp.png")
```


### Visualize leafhopper counts vs. precipitation
