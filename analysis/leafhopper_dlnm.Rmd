---
title: "Leafhopper distributed lag model"
author: "Eric R. Scott"
date: "2020-01-25"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, paged.print = FALSE)
options(scipen = 4)
```

*Last compiled: `r Sys.Date()`*

```{r packages, message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(conflicted)
library(mgcv)
library(dlnm)
library(colorspace)
library(bbmle)

conflict_prefer("filter", "dplyr")
conflict_prefer("here", "here")
conflict_prefer("lag", "dplyr")
conflict_prefer("select", "dplyr")
```


# Goal

This analysis is based on Gasparrini A, Scheipl F, Armstrong B, Kenward MG (2017) A penalized framework for distributed lag non-linear models. Biometrics 73:938â€“948. doi: 10.1111/biom.12645.  Specifically, it is based on `ex1_01.int.R` provided in their code.  This "internal" method for distributed lag models takes full(?) advantage of built in features of `gam`s.

The goal is to model the effects of temperature and precipitation on leafhoppers as having a quadratic, lagged effect.  The lag is modeled as a penalized cubic regression spline and the effect of temperature as a 2nd order polynomial in a crossbasis smoother. In an ideal world, the penalized spline would be the shrinkage version (bs = "cs"), but that isn't available in the crossbasis smooth constructor provided by `dlnm`.

# Read in Data

```{r}
hoppers <- read_rds(here("data", "cleaned", "hopper-weather.rds"))

head(hoppers)
# str(hoppers)
```


# Distributed Lag Model: "internal" method

## Build the GAMs

Temp and precip are highly concurve, so can't trust p-values. I'll do the models separately.

```{r}
m_hopper_temp_mean <- 
  gam(hoppers ~
        s(Q_temp_mean, L,
          bs = "cb",
          k = c(10, 14),
          xt = list(bs = "cr")
        ) +
        s(day_post, bs = "cr") +
        s(counter, bs = "re") + #no difference with random vs. fixed
        # counter +
        s(interharvest_id, bs = "re") +
        s(plant, bs = "re"),
      family = poisson(),
      offset = log(n_leaves),
      data = hoppers,
      gamma = 1.2,
      method = "REML")

m_hopper_temp_min <- 
  gam(hoppers ~
        s(Q_temp_min, L,
          bs = "cb",
          k = c(10, 14),
          xt = list(bs = "cr")
        ) +
        s(day_post, bs = "cr") +
        s(counter, bs = "re") + #no difference with random vs. fixed
        # counter +
        s(interharvest_id, bs = "re") +
        s(plant, bs = "re"),
      family = poisson(),
      offset = log(n_leaves),
      data = hoppers,
      gamma = 1.2,
      method = "REML")

m_hopper_temp_max <- 
  gam(hoppers ~
        s(Q_temp_max, L,
          bs = "cb",
          k = c(10, 14),
          xt = list(bs = "cr")
        ) +
        s(day_post, bs = "cr") +
        s(counter, bs = "re") + #no difference with random vs. fixed
        # counter +
        s(interharvest_id, bs = "re") +
        s(plant, bs = "re"),
      family = poisson(),
      offset = log(n_leaves),
      data = hoppers,
      gamma = 1.2,
      method = "REML")

m_hopper_precip <- 
  gam(hoppers ~
        s(Q_precip, L,
          bs = "cb",
          k = c(10, 14),
          xt = list(bs = "cr")
        ) +
        s(day_post, bs = "cr") +
        s(counter, bs = "re") + #no difference with random vs. fixed
        # counter +
        s(interharvest_id, bs = "re") +
        s(plant, bs = "re"),
      family = poisson(),
      offset = log(n_leaves),
      data = hoppers,
      gamma = 1.2,
      method = "REML")
```

```{r}
ICtab(m_hopper_temp_mean, m_hopper_temp_min, m_hopper_temp_max, m_hopper_precip)
```

Minimum temperature model "wins"

# Mean Temperature

## Inspect the GAM

```{r}
#check for overdispersion
sum(residuals(m_hopper_temp_mean, type = "pearson")^2) / df.residual(m_hopper_temp_mean)
gam.check(m_hopper_temp_mean)
```

not overdispersed

## Significance test

```{r}
anova.gam(m_hopper_temp_mean)
```

Significant effect of plant (parametric factor), temperature, precip, days post harvest, and diameter on growth.

## Plot regular smooths of covariates

```{r}
plot.gam(m_hopper_temp_mean, pages = 1, residuals = FALSE, all.terms = TRUE)
plot.gam(m_hopper_temp_min, pages = 1, residuals = FALSE, all.terms = TRUE)
plot.gam(m_hopper_temp_max, pages = 1, residuals = FALSE, all.terms = TRUE)
plot.gam(m_hopper_precip, pages = 1, residuals = FALSE, all.terms = TRUE)
```

# Minimum temperature

## Inspect the GAM

```{r}
gam.check(m_hopper_temp_min)
#check for overdispersion
sum(residuals(m_hopper_temp_min, type = "pearson")^2) / df.residual(m_hopper_temp_min)
```

## Significance test

```{r}
anova.gam(m_hopper_temp_min)
```

Min temp is significant

# Maximum temperature

```{r}
gam.check(m_hopper_temp_max)
#check for overdispersion
sum(residuals(m_hopper_temp_max, type = "pearson")^2) / df.residual(m_hopper_temp_max)
```

```{r}
anova.gam(m_hopper_temp_max)
```

max temp also highly significant.

# Precip

Inspect gam:

```{r}
gam.check(m_hopper_precip)
```



```{r}
anova.gam(m_hopper_precip)
```

significant effect of precip, but not of date.

### Plot regular smooths for co-variates

Not significant, so these won't be in the paper

```{r}
plot.gam(m_hopper_precip,
         all.terms = TRUE,
         pages = 1,
         shift = coef(m_hopper_precip)[1]
         )
```

# Save models

```{r}
write_rds(m_hopper_precip, here("analysis", "models", "m_hopper_precip.rds"))
write_rds(m_hopper_temp_max, here("analysis", "models", "m_hopper_temp_max.rds"))
write_rds(m_hopper_temp_mean, here("analysis", "models", "m_hopper_temp_mean.rds"))
write_rds(m_hopper_temp_min, here("analysis", "models", "m_hopper_temp_min.rds"))
```

