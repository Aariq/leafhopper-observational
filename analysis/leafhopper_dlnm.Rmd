---
title: "Leafhopper distributed lag model"
author: "Eric R. Scott"
date: "2020-01-25"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---
#TODO

- Tidy up analysis
- export figures


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 4)
```

*Last compiled: `r Sys.Date()`*

```{r packages, message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(conflicted)
library(mgcv)
library(dlnm)

conflict_prefer("filter", "dplyr")
conflict_prefer("here", "here")
conflict_prefer("lag", "dplyr")
conflict_prefer("select", "dplyr")
```

# Goal

This analysis is based on Gasparrini A, Scheipl F, Armstrong B, Kenward MG (2017) A penalized framework for distributed lag non-linear models. Biometrics 73:938–948. doi: 10.1111/biom.12645.  Specifically, it is based on `ex1_01.int.R` provided in their code.  This "internal" method for distributed lag models takes full(?) advantage of built in features of `gam`s.

The goal is to model the effects of temperature and precipitation on leafhoppers as having a quadratic, lagged effect.  The lag is modeled as a penalized cubic regression spline and the effect of temperature as a 2nd order polynomial in a crossbasis smoother. In an ideal world, the penalized spline would be the shrinkage version (bs = "cs"), but that isn't available in the crossbasis smooth constructor provided by `dlnm`.

# Read in Data

```{r}
hoppers <- read_rds(here("data", "cleaned", "hopper-weather.rds"))

hoppers <- hoppers %>% 
  mutate(interharvest_id = as.factor(paste0(field, interharvest.no)),
         counter = as.factor(counter),
         plant = as.factor(plant)) %>% 
  filter(!is.na(precip_lag15)) #get rid of plants that don't have 15 days of data

head(hoppers)
# str(hoppers)
```


# Distributed Lag Model: "internal" method

## Setup

Create matrices for temperature, precip, and lag.

```{r}
Q_temp <-
  hoppers %>% 
  select(starts_with("temp"), -temp_at_count, -temp_max, -temp_min) %>% 
  as.matrix()

Q_precip <-
  hoppers %>%
  select(starts_with("precip")) %>% 
  as.matrix()

L <- matrix(0:(ncol(Q_temp)-1), nrow(Q_temp), ncol(Q_temp), byrow = TRUE)
```

# Build the GAMs


```{r}
m_hopper <- 
  gam(hoppers ~
        s(Q_temp, L,
          bs = "cb",
          k = c(5, 7),
          xt = list(bs = "cr")
        ) +
        s(Q_precip, L,
          bs = "cb",
          k = c(5, 7),
          xt = list(bs = "cr")
        ) +
        s(day, bs = "cs") +
        s(day_post, bs = "cs") +
        s(counter, bs = "re") + #no difference with random vs. fixed
        s(interharvest_id, bs = "re") +
        s(plant, bs = "re"),
      family = poisson(),
      offset = log(n_leaves),
      data = hoppers,
      # gamma = 1.2, #values above 1 make smoother.  Borrowed from Teller et al.
      method = "REML")
beepr::beep(3)
```

```{r}
gam.check(m_hopper)
```
```{r}
concurvity(m_hopper)
# concurvity(m_hopper, full = FALSE)
```

Temp and precip are highly concurve, so can't trust p-values. I'll do the models separately.


```{r}
m_hopper_temp <- 
  gam(hoppers ~
        s(Q_temp, L,
          bs = "cb",
          k = c(5, 7),
          xt = list(bs = "cr")
        ) +
        s(day, bs = "cs") +
        s(day_post, bs = "cs") +
        s(counter, bs = "re") + #no difference with random vs. fixed
        s(interharvest_id, bs = "re") +
        s(plant, bs = "re"),
      family = poisson(),
      offset = log(n_leaves),
      data = hoppers,
      # gamma = 1.2, #values above 1 make smoother.  Borrowed from Teller et al.
      method = "REML")

m_hopper_precip <- 
  gam(hoppers ~
        s(Q_precip, L,
          bs = "cb",
          k = c(5, 7),
          xt = list(bs = "cr")
        ) +
        s(day, bs = "cs") +
        s(day_post, bs = "cs") +
        s(counter, bs = "re") + #no difference with random vs. fixed
        s(interharvest_id, bs = "re") +
        s(plant, bs = "re"),
      family = poisson(),
      offset = log(n_leaves),
      data = hoppers,
      # gamma = 1.2, #values above 1 make smoother.  Borrowed from Teller et al.
      method = "REML")

beepr::beep(3)
```
```{r}
AIC(m_hopper_temp, m_hopper_precip)
bbmle::ICtab(m_hopper_temp, m_hopper_precip)
```

Precip model wins.

# Temperature

## Inspect the GAM

```{r}
gam.check(m_hopper_temp)
#check for overdispersion
sum(residuals(m_hopper_temp, type = "pearson")^2) / df.residual(m_hopper_temp)
```

not overdispersed

```{r}
concurvity(m_hopper_temp, full = TRUE)
# concurvity(m_hopper_temp, full = FALSE)
```

Day and temperature have high concurvity.  They are highly correlated, but correlations breaks down quickly through lag time  I'm going to include both.


## Significance test

```{r}
anova.gam(m_hopper_temp)
```
Significant effect of plant (parametric factor), temperature, precip, days post harvest, and diameter on growth.

## Predictions and plots

### Plot regular smooths

```{r}
plot(m_hopper_temp, pages = 1, residuals = FALSE)
```

### Plot crossbasis smooths

```{r}
# cen = 22
cen = round(mean(hoppers$temp_mean), 2)
# cen= NULL
pred_temp <- crosspred("Q_temp", m_hopper_temp, cen = cen)
pred_temp2 <- crosspred("Q_temp", m_hopper_temp, by = 0.2, bylag = 0.2, cen = cen)

#3D
png(here("figs", "hopper_temp_contour.png"))
plot(pred_temp,
     ptype = "contour",
     xlab = "Temperature (C)",
     ylab = "lag (days)",
     main = glue::glue("Temperature (center = {cen}ºC)"))
dev.off()

# Overall effect of temp
# png(here("figs", "hopper_temp_overall.png"))
plot(pred_temp2,
     "overall",
     # ci = "bars",
     ylab = "Relative change in leafhoppers / leaf",
     xlab = "Temperature (C)",
     main = "Cumulative Temperature Effects")
# dev.off()

# png(here("figs", "hopper_temp_lag.png"))
plot(pred_temp2,
     var = 21,
     xlab = "Lag (days)",
     ylab = "Relative change in leafhoppers / leaf",
     main = "Effect of Lag for 21ºC")
# dev.off()
```

Cooler temperatures are good for leafhoppers.  Little discernable effect of lag.  Not sure how to interpret


# Precip

```{r}
gam.check(m_hopper_precip)
```
```{r}
concurvity(m_hopper_precip)
# concurvity(m_hopper_precip, full = FALSE)
```


```{r}
anova.gam(m_hopper_precip)
```

significant effect of precip, but not of date.

```{r}
plot(m_hopper_precip)
```

```{r}
# cen = 40
# cen = NULL
cen = round(mean(hoppers$temp_mean),1)
pred_precip <- crosspred("Q_precip", m_hopper_precip, cen = cen)
pred_precip2 <- crosspred("Q_precip", m_hopper_precip, by = 0.2, bylag = 0.2, cen = cen)

#3D
# png(here("figs", "hopper_precip_contour.png"))
plot(pred_precip,
     ptype = "contour",
     xlab = "Precip (mm)",
     ylab = "lag (days)",
     main = glue::glue("Precipitation (center = {cen}mm)"))
# dev.off()

# Overall effect of precip
# png(here("figs", "hopper_precip_overall.png"))
plot(pred_precip2,
     "overall",
     ylab = "Relative change in leafhoppers / leaf",
     xlab = "Precip (mm)",
     main = "Cumulative Precipitation Effect",
     ylim = c(0,20))
# dev.off()

# png(here("figs", "hopper_precip_0lag.png"))
plot(pred_precip2,
     var = 1,
     xlab = "Lag (days)",
     ylab = "Relative change in leafhoppers / leaf",
     main = "Effect of Lag for 0 mm")
# dev.off()

# png(here("figs", "hopper_precip_80lag.png"))
plot(pred_precip2,
     var = 80,
     xlab = "Lag (days)",
     ylab = "Relative change in leafhoppers / leaf",
     main = "Effect of Lag for 80 mm")
# dve.off()
```

Low precip at 5 and 11 days ago has negative effect on leafhoppers (dessication?)

High precip has positive effect on leafhoppers

# Conclusion