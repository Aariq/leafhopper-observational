---
title: "Leafhopper distributed lag model"
author: "Eric R. Scott"
date: "2020-01-25"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---
#TODO

- Tidy up analysis


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 4)
```

*Last compiled: `r Sys.Date()`*

```{r packages, message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(conflicted)
library(mgcv)
library(dlnm)
library(colorspace)
library(cowplot)
library(bbmle)
library(patchwork)

conflict_prefer("filter", "dplyr")
conflict_prefer("here", "here")
conflict_prefer("lag", "dplyr")
conflict_prefer("select", "dplyr")

source(here("analysis", "functions.R"))
```


# Goal

This analysis is based on Gasparrini A, Scheipl F, Armstrong B, Kenward MG (2017) A penalized framework for distributed lag non-linear models. Biometrics 73:938–948. doi: 10.1111/biom.12645.  Specifically, it is based on `ex1_01.int.R` provided in their code.  This "internal" method for distributed lag models takes full(?) advantage of built in features of `gam`s.

The goal is to model the effects of temperature and precipitation on leafhoppers as having a quadratic, lagged effect.  The lag is modeled as a penalized cubic regression spline and the effect of temperature as a 2nd order polynomial in a crossbasis smoother. In an ideal world, the penalized spline would be the shrinkage version (bs = "cs"), but that isn't available in the crossbasis smooth constructor provided by `dlnm`.

# Read in Data

```{r}
hoppers <- read_rds(here("data", "cleaned", "hopper-weather.rds"))

hoppers <- hoppers %>% 
  mutate(interharvest_id = as.factor(paste0(field, interharvest.no)),
         counter = as.factor(counter),
         plant = as.factor(plant)) %>% 
  filter(!is.na(precip_lag15)) #get rid of plants that don't have 15 days of data

head(hoppers)
# str(hoppers)
```


# Distributed Lag Model: "internal" method

## Setup

Create matrices for temperature, precip, and lag.

```{r}
Q_temp <-
  hoppers %>% 
  select(starts_with("temp_lag"), -temp_at_count, -temp_max, -temp_min) %>% 
  as.matrix()

Q_min_temp <-
  hoppers %>% 
  select(starts_with("temp_min_lag")) %>% 
  as.matrix()

Q_max_temp <-
  hoppers %>% 
  select(starts_with("temp_max_lag")) %>% 
  as.matrix()

Q_precip <-
  hoppers %>%
  select(starts_with("precip_lag")) %>% 
  as.matrix()

L <- matrix(1:(ncol(Q_temp)), nrow(Q_temp), ncol(Q_temp), byrow = TRUE)
```

# Build the GAMs

Temp and precip are highly concurve, so can't trust p-values. I'll do the models separately.

```{r}
#mean daily temp
m_hopper_temp <- 
  gam(hoppers ~
        s(Q_temp, L,
          bs = "cb",
          k = c(5, 7),
          xt = list(bs = "cr")
        ) +
        s(day_post, bs = "cs") +
        s(counter, bs = "re") + #no difference with random vs. fixed
        s(interharvest_id, bs = "re") +
        s(plant, bs = "re"),
      family = poisson(),
      offset = log(n_leaves),
      data = hoppers,
      method = "REML")

m_hopper_min_temp <- 
  gam(hoppers ~
        s(Q_min_temp, L,
          bs = "cb",
          k = c(5, 7),
          xt = list(bs = "cr")
        ) +
        s(day_post, bs = "cs") +
        s(counter, bs = "re") + #no difference with random vs. fixed
        s(interharvest_id, bs = "re") +
        s(plant, bs = "re"),
      family = poisson(),
      offset = log(n_leaves),
      data = hoppers,
      method = "REML")

m_hopper_max_temp <- 
  gam(hoppers ~
        s(Q_max_temp, L,
          bs = "cb",
          k = c(5, 7),
          xt = list(bs = "cr")
        ) +
        s(day_post, bs = "cs") +
        s(counter, bs = "re") + #no difference with random vs. fixed
        s(interharvest_id, bs = "re") +
        s(plant, bs = "re"),
      family = poisson(),
      offset = log(n_leaves),
      data = hoppers,
      method = "REML")

m_hopper_precip <- 
  gam(hoppers ~
        s(Q_precip, L,
          bs = "cb",
          k = c(5, 7),
          xt = list(bs = "cr")
        ) +
        s(day_post, bs = "cs") +
        s(counter, bs = "re") + #no difference with random vs. fixed
        s(interharvest_id, bs = "re") +
        s(plant, bs = "re"),
      family = poisson(),
      offset = log(n_leaves),
      data = hoppers,
      method = "REML")
```

```{r}
ICtab(m_hopper_temp, m_hopper_min_temp, m_hopper_max_temp, m_hopper_precip)
```

Precip model wins.

# Mean Temperature

## Inspect the GAM

```{r}
gam.check(m_hopper_temp)
#check for overdispersion
sum(residuals(m_hopper_temp, type = "pearson")^2) / df.residual(m_hopper_temp)
```

not overdispersed

## Significance test

```{r}
anova.gam(m_hopper_temp)
```

Significant effect of plant (parametric factor), temperature, precip, days post harvest, and diameter on growth.

## Plot regular smooths of covariates

These are non-significant, so I won't include them in the paper figure.

```{r}
plot.gam(m_hopper_temp, pages = 1, residuals = FALSE, all.terms = TRUE)
```

# Minimum temperature

## Inspect the GAM

```{r}
gam.check(m_hopper_min_temp)
#check for overdispersion
sum(residuals(m_hopper_min_temp, type = "pearson")^2) / df.residual(m_hopper_min_temp)
```

## Significance test

```{r}
anova.gam(m_hopper_min_temp)
```

Min temp is significant

# Maximum temperature
```{r}
gam.check(m_hopper_max_temp)
#check for overdispersion
sum(residuals(m_hopper_max_temp, type = "pearson")^2) / df.residual(m_hopper_max_temp)
```

```{r}
anova.gam(m_hopper_max_temp)
```

max temp also highly significant.

# Precip

Inspect gam:

```{r}
gam.check(m_hopper_precip)
```



```{r}
anova.gam(m_hopper_precip)
```

significant effect of precip, but not of date.

### Plot regular smooths for co-variates

Not significant, so these won't be in the paper

```{r}
plot(m_hopper_precip, all.terms = TRUE, pages = 1)
```


# Plots

## Generate plot data

```{r}
ht_pd <- pred_hoppers(Q_temp, L, hoppers, "temp_mean", m_hopper_temp)
htmin_pd <- pred_hoppers(Q_min_temp, L, hoppers, "temp_min", m_hopper_min_temp)
htmax_pd <- pred_hoppers(Q_max_temp, L, hoppers, "temp_max", m_hopper_max_temp)
hp_pd <- pred_hoppers(Q_precip, L, hoppers, "precip_mm", m_hopper_precip)
```


common scale:

```{r}
hopper_lim <- c(min(ht_pd$fitted, htmin_pd$fitted, htmax_pd$fitted, hp_pd$fitted),
                max(ht_pd$fitted, htmin_pd$fitted, htmax_pd$fitted, hp_pd$fitted))
```

## Mean Temperature cross-basis

```{r}
hopper_temp_raster <-
  ggplot(ht_pd, aes(x = x, y = lag, z = fitted, fill = fitted)) +
  geom_raster(interpolate = TRUE) +
  geom_contour(color = "grey50", size = 0.4) +
  scale_fill_viridis_c("Leafhoppers \n per leaf", option = "A", limits = hopper_lim) + 
  scale_y_continuous("Lag (days)", expand = c(0,0)) + 
  scale_x_continuous("Temperature (ºC)", expand = c(0,0)) +
  theme(text = element_text(size = 14), aspect.ratio = 1)
hopper_temp_raster
save_plot(here("figs", "hopper_temp_raster.png"), hopper_temp_raster)
```

Cooler temperatures are good for leafhoppers.  Little discernable effect of lag.  Not sure how to interpret

## Minimum Temperature cross-basis

```{r}
hopper_min_temp_raster <-
  ggplot(htmin_pd, aes(x = x, y = lag, z = fitted, fill = fitted)) +
  geom_raster(interpolate = TRUE) +
  geom_contour(color = "grey50", size = 0.4) +
  scale_fill_viridis_c("Leafhoppers \n per leaf", option = "A", limits = hopper_lim) + 
  scale_y_continuous("Lag (days)", expand = c(0,0)) + 
  scale_x_continuous("Temperature (ºC)", expand = c(0,0)) +
  theme(text = element_text(size = 14), aspect.ratio = 1)
hopper_min_temp_raster
save_plot(here("figs", "hopper_min_temp_raster.png"), hopper_min_temp_raster)
```

## Maximum temperature cross-basis

```{r}
hopper_max_temp_raster <-
  ggplot(htmax_pd, aes(x = x, y = lag, z = fitted, fill = fitted)) +
  geom_raster(interpolate = TRUE) +
  geom_contour(color = "grey50", size = 0.4) +
  scale_fill_viridis_c("Leafhoppers \n per leaf", option = "A", limits = hopper_lim) + 
  scale_y_continuous("Lag (days)", expand = c(0,0)) + 
  scale_x_continuous("Temperature (ºC)", expand = c(0,0)) +
  theme(text = element_text(size = 14), aspect.ratio = 1)
hopper_max_temp_raster
save_plot(here("figs", "hopper_max_temp_raster.png"), hopper_max_temp_raster)
```


## Precipitation cross-basis

```{r}
hopper_precip_raster <-
  ggplot(hp_pd, aes(x = x, y = lag, z = fitted, fill = fitted)) +
  geom_raster(interpolate = TRUE) +
  geom_contour(color = "grey50", size = 0.4) +
  scale_fill_viridis_c("Leafhoppers \n per leaf", option = "A", limits = hopper_lim) + 
  scale_y_continuous("Lag (days)", expand = c(0,0)) + 
  scale_x_continuous("Precipitation (mm)", expand = c(0,0)) +
  theme(text = element_text(size = 14), aspect.ratio = 1)
hopper_precip_raster
save_plot(here("figs", "hopper_precip_raster.png"), hopper_precip_raster)
```
Low precip at 5 and 11 days ago has negative effect on leafhoppers (dessication?)

High precip has positive effect on leafhoppers


## Combine raster plots

```{r}
hopper_cbs <- 
  hopper_precip_raster + 
  hopper_temp_raster + 
  plot_layout(guide = "collect") + 
  plot_annotation(tag_levels = "A")

save_plot(here("figs", "hopper_crossbasis.png"), hopper_cbs,
          ncol = 2, nrow = 1, base_asp = 1)
```
