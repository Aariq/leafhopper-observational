---
title: "Leafhopper distributed lag model"
author: "Eric R. Scott"
date: "2020-01-25"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, paged.print = FALSE)
options(scipen = 4)
```

*Last compiled: `r Sys.Date()`*

```{r packages, message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(conflicted)
library(mgcv)
library(dlnm)
library(colorspace)
library(bbmle)
library(patchwork)
library(visibly) #for ggplot figures from GAMs

conflict_prefer("filter", "dplyr")
conflict_prefer("here", "here")
conflict_prefer("lag", "dplyr")
conflict_prefer("select", "dplyr")

source(here("R", "crossbasis.r"))
```


# Goal

This analysis is based on Gasparrini A, Scheipl F, Armstrong B, Kenward MG (2017) A penalized framework for distributed lag non-linear models. Biometrics 73:938–948. doi: 10.1111/biom.12645.  Specifically, it is based on `ex1_01.int.R` provided in their code.  This "internal" method for distributed lag models takes full(?) advantage of built in features of `gam`s.

The goal is to model the effects of temperature and precipitation on leafhoppers as having a quadratic, lagged effect.  The lag is modeled as a penalized cubic regression spline and the effect of temperature as a 2nd order polynomial in a crossbasis smoother. In an ideal world, the penalized spline would be the shrinkage version (bs = "cs"), but that isn't available in the crossbasis smooth constructor provided by `dlnm`.

# Read in Data

```{r}
hoppers <- read_rds(here("data", "cleaned", "hopper-weather.rds"))

head(hoppers)
# str(hoppers)
```


# Distributed Lag Model: "internal" method

## Build the GAMs

Temp and precip are highly concurve, so can't trust p-values. I'll do the models separately.

```{r}
#mean daily temp

m_hopper_temp_mean <- 
  gam(hoppers ~
        s(Q_temp_mean, L,
          bs = "cb",
          k = c(5, 7),
          xt = list(bs = "cr")
        ) +
        s(day_post, bs = "cs") +
        s(counter, bs = "re") + #no difference with random vs. fixed
        # counter +
        s(interharvest_id, bs = "re") +
        s(plant, bs = "re"),
      family = poisson(),
      offset = log(n_leaves),
      data = hoppers,
      method = "REML")

m_hopper_temp_min <- 
  gam(hoppers ~
        s(Q_temp_min, L,
          bs = "cb",
          k = c(5, 7),
          xt = list(bs = "cr")
        ) +
        s(day_post, bs = "cs") +
        s(counter, bs = "re") + #no difference with random vs. fixed
        # counter +
        s(interharvest_id, bs = "re") +
        s(plant, bs = "re"),
      family = poisson(),
      offset = log(n_leaves),
      data = hoppers,
      method = "REML")

m_hopper_temp_max <- 
  gam(hoppers ~
        s(Q_temp_max, L,
          bs = "cb",
          k = c(5, 7),
          xt = list(bs = "cr")
        ) +
        s(day_post, bs = "cs") +
        s(counter, bs = "re") + #no difference with random vs. fixed
        # counter +
        s(interharvest_id, bs = "re") +
        s(plant, bs = "re"),
      family = poisson(),
      offset = log(n_leaves),
      data = hoppers,
      method = "REML")

m_hopper_precip <- 
  gam(hoppers ~
        s(Q_precip, L,
          bs = "cb",
          k = c(5, 7),
          xt = list(bs = "cr")
        ) +
        s(day_post, bs = "cs") +
        s(counter, bs = "re") + #no difference with random vs. fixed
        # counter +
        s(interharvest_id, bs = "re") +
        s(plant, bs = "re"),
      family = poisson(),
      offset = log(n_leaves),
      data = hoppers,
      method = "REML")
```

```{r}
ICtab(m_hopper_temp_mean, m_hopper_temp_min, m_hopper_temp_max, m_hopper_precip)
```

Minimum temperature model "wins"

# Mean Temperature

## Inspect the GAM

```{r}
#check for overdispersion
sum(residuals(m_hopper_temp_mean, type = "pearson")^2) / df.residual(m_hopper_temp_mean)
plot_gam_check(m_hopper_temp_mean)
```

not overdispersed

## Significance test

```{r}
anova.gam(m_hopper_temp_mean)
```

Significant effect of plant (parametric factor), temperature, precip, days post harvest, and diameter on growth.

## Plot regular smooths of covariates

```{r}
plot.gam(m_hopper_temp_mean, pages = 1, residuals = FALSE, all.terms = TRUE)
plot.gam(m_hopper_temp_min, pages = 1, residuals = FALSE, all.terms = TRUE)
plot.gam(m_hopper_temp_max, pages = 1, residuals = FALSE, all.terms = TRUE)
plot.gam(m_hopper_precip, pages = 1, residuals = FALSE, all.terms = TRUE)
```

# Minimum temperature

## Inspect the GAM

```{r}
plot_gam_check(m_hopper_temp_min)
#check for overdispersion
sum(residuals(m_hopper_temp_min, type = "pearson")^2) / df.residual(m_hopper_temp_min)
```

## Significance test

```{r}
anova.gam(m_hopper_temp_min)
```

Min temp is significant

# Maximum temperature

```{r}
plot_gam_check(m_hopper_temp_max)
#check for overdispersion
sum(residuals(m_hopper_temp_max, type = "pearson")^2) / df.residual(m_hopper_temp_max)
```

```{r}
anova.gam(m_hopper_temp_max)
```

max temp also highly significant.

# Precip

Inspect gam:

```{r}
plot_gam_check(m_hopper_precip)
```



```{r}
anova.gam(m_hopper_precip)
```

significant effect of precip, but not of date.

### Plot regular smooths for co-variates

Not significant, so these won't be in the paper

```{r}
plot.gam(m_hopper_precip,
         all.terms = TRUE,
         pages = 1,
         shift = coef(m_hopper_precip)[1]
         )
```


# Plots

## Covaraiate

Days post-harvest

```{r}
d <- list("Mean Temperature" = m_hopper_temp_mean,
         "Minimum Temperature" = m_hopper_temp_min,
         "Precipitation" = m_hopper_precip) %>%
  map(~plot_gam(.x, main_var = day_post))

dph_plot <-
  d %>%
  map_df(~pluck(.x,"data"), .id = "model") %>% 
  ggplot(aes(x = value, y = fit, color = model)) +
  geom_ribbon(aes(ymin = ll, ymax = ul), 
              fill = "grey", linetype = 0, alpha = 0.5) +
  geom_line(size = 1) +
  geom_rug(data = hoppers, aes(day_post), inherit.aes = FALSE, alpha = 0.03) +
  labs(x = "Days post harvest", y = "Leafhoppers / leaf", color = "Model") +
  theme_bw() +
  theme(aspect.ratio = 1)
dph_plot
ggsave(here("figs", "hopper_covariates.png"), dph_plot, width = 165, height = 130, units = "mm")
```

## Generate plot data

`visibly` packakge can't handle these cross-basis smooths apparently.

```{r}
ht_pd <- cb_margeff(m_hopper_temp_mean, Q_temp_mean, L) 
htmin_pd <- cb_margeff(m_hopper_temp_min, Q_temp_min, L)
htmax_pd <- cb_margeff(m_hopper_temp_max, Q_temp_max, L)
hp_pd <- cb_margeff(m_hopper_precip, Q_precip, L) 
```


common scale:

```{r}
hopper_lim <- c(min(exp(ht_pd$fitted), 
                    exp(htmin_pd$fitted),
                    exp(htmax_pd$fitted), 
                    exp(hp_pd$fitted)),
                max(exp(ht_pd$fitted),
                    exp(htmin_pd$fitted),
                    exp(htmax_pd$fitted),
                    exp(hp_pd$fitted)))
```

## Mean Temperature cross-basis

```{r}
hopper_temp_raster <-
  ggplot(filter(ht_pd, min_dist < 0.1),
         aes(x = x, y = lag, z = exp(fitted), fill = exp(fitted))) +
  geom_raster(interpolate = TRUE) +
  geom_contour(color = "grey50", size = 0.4, binwidth = 0.005) +
  scale_fill_viridis_c("Leafhoppers\nper leaf",
                       option = "A",
                       limits = hopper_lim) + 
  scale_y_continuous("Lag (days)", expand = c(0,0)) + 
  scale_x_continuous("Daily Mean Temperature (ºC)", expand = c(0,0))
hopper_temp_raster
# ggsave(here("figs", "hopper_temp_raster.png"))
```


## Minimum Temperature cross-basis

```{r}
hopper_min_temp_raster <-
  ggplot(filter(htmin_pd, min_dist < 0.1),
         aes(x = x, y = lag, z = exp(fitted), fill = exp(fitted))) +
  geom_raster(interpolate = TRUE) +
  geom_contour(color = "grey50", size = 0.4, binwidth = 0.005) +
  # geom_rug(alpha = 0.3) + #if I include this, it should be from the weather data and only on the x-axis I think.
  scale_fill_viridis_c("Leafhoppers\nper leaf",
                       option = "A", 
                       limits = hopper_lim) + 
  scale_y_continuous("Lag (days)", expand = c(0,0)) + 
  scale_x_continuous("Daily Minimum Temperature (ºC)", expand = c(0,0))
hopper_min_temp_raster
# ggsave(here("figs", "hopper_min_temp_raster.png"))
```
Recent cool temperatures bad for leafhoppers (it's cold out, they're less active)

## Maximum temperature cross-basis

```{r}
hopper_max_temp_raster <-
  ggplot(filter(htmax_pd, min_dist < 0.1),
         aes(x = x, y = lag, z = exp(fitted), fill = exp(fitted))) +
  geom_raster(interpolate = TRUE) +
  geom_contour(color = "grey50", size = 0.4, binwidth = 0.005) +
  scale_fill_viridis_c("Leafhoppers\nper leaf",
                       option = "A",
                       limits = hopper_lim) + 
  scale_y_continuous("Lag (days)", expand = c(0,0)) + 
  scale_x_continuous("Daily Maximum Temperature (ºC)", expand = c(0,0))
hopper_max_temp_raster
# ggsave(here("figs", "hopper_max_temp_raster.png"))
```
Not much of a pattern with max temp.

## Precipitation cross-basis

```{r}
hopper_precip_raster <-
  ggplot(filter(hp_pd, min_dist < 0.1),
         aes(x = x, y = lag, z = exp(fitted), fill = exp(fitted))) +
  geom_raster(interpolate = TRUE) +
  geom_contour(color = "grey50", size = 0.4, binwidth = 0.005) +
  scale_fill_viridis_c("Leafhoppers\nper leaf",
                       option = "A",
                       limits = hopper_lim) + 
  scale_y_continuous("Lag (days)", expand = c(0,0)) + 
  scale_x_continuous("Daily Precipitation (mm)", expand = c(0,0))
hopper_precip_raster
# ggsave(here("figs", "hopper_precip_raster.png"))
```

High precip 10-12 days ago has positive effect on leafhoppers


## Combine raster plots

```{r}
hopper_cb <-
  hopper_min_temp_raster +
  hopper_temp_raster +
  hopper_max_temp_raster +
  hopper_precip_raster +
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = "A") &
  theme_classic()
hopper_cb
ggsave(here("figs", "hopper_crossbasis.png"), hopper_cb, width = 165, units = "mm")
ggsave(here("figs", "figure 2.eps"), hopper_cb, width = 165, units = "mm")
```
