---
title: "Preliminary analysis of shoot growth data"
author: "Eric R. Scott"
date: "2017-06-05"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

*Last compiled: `r Sys.Date()`*

```{r packages, message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(lme4)
library(car)
library(broom)
library(plotly)
library(here)
library(conflicted)
library(bbmle)
library(lmtest)
conflict_prefer("filter", "dplyr")
conflict_prefer("here", "here")
conflict_prefer("lag", "dplyr")
```

# Read in Data

```{r}
shoot.data <- read_rds(here("data", "cleaned", "shoots.rds"))
head(shoot.data)
```
`shoot.data` contains

 - `date`, the date of the observation
 - `day`, day from first measurement 
 - `field`, whether it's from field A or B
 - `harvest`, did they hareves yesterday?
 - `plant`, plant ID within field.  It's the same plant ever interharvest period
 - `shoot`, shoot ID within plant.  These are different shoots each interhavest period
 - `shoot_id`, unique shoot ID in the form of f{field}-h{interhaverst.no}-p{plant}-s{shoot#}
 - `shoot_height` shoot height in cm
 - `interharvest` Which interharvest period?  Date listed is the last day of that interharvest period
 - `interharvest.no` Which interharvest period? 1-4 as character, for easier filtering and faceting in plots
 - `growth` difference from the previous day's `shoot_height`
 - `diameter` shoot diameter in (UNITS??)
 - `temp_mean`, mean daily temperature in ºC
 - `temp_max`, maximum daily temperature in ºC
 - `temp_min`, minimum daily temperature in ºC
 - `precip_caas`, precip from weather station in mm
 - `sun_hrs`, from weather station
 - `rh`, relative humidity from weather station
 - `precip_mm`, precip from rain gauge

# Purpose
Determine effects of temperature and precipitation on shoot growth.

## Experimental Design
Two fields (A and B).  10 plants in each field, 7 shoots on each plant.  Daily measurements of growth.  Shoots reset every harvest and stem diameter measured as co-variate.  Three inter-harvest periods for each site (but overlapping).  Hourly temperature measurements (converted to daily max, min, mean).

## Goal of analysis
Is there an effect of temperature on shoot growth?  Is the effect linear or quadratic (that is, does growth slow when it's too hot)?  Does shoot growth differ between the two fields.  I also have data on precipitation and "sunshine hours" which could impact shoot growth, but I'm going to start by modeling the effects of temperature.


## Measuring growth

After conversations with Collin, I think that linear growth is the most appropriate way to model growth.  There are two ways I could approach this. I think it might be wise to try both.  If they give me similar results, that's good news.


### Option 1: Daily growth rate
Daily growth rate calculated at $r = h_{t+1} - h_t$.  Then I would model growth rate as a quadratic effect of temperature.  With this method, the effect of field is, I think, confounded with interharvest period since the two fields were not harvested on the same schedule.  I also can't use interharvest period as a nested random effect because there are only two harvest periods for field B.  So, the best option is to use field-harvest as a randome effect.  The downside of this is all I can say is that harvest/fields are different.  I won't be able to say if growth rates change systematically as a funciton of harvest date, for example. I would be able to use stem diameter and day post harvest as co-variates and plant ID as a random effect.

Can I use mean harvest date as a fixed effect?  I think we decided no, but I'm not sure why.

### Option 2: Fit lines for each shoot
Fit a line for each shoot (within each interharvest period).  Then, use the slope of that line as a response variable.  Then, I'd need to calcualte a cumulative effect of temperature like cumulative degree days.  This variable could include a quadratic effect (e.g. cumulative degree days = cum(temp) + cum(temp^2), I think).  Then I'd model growth rate (slope) as a function of cumulative degree days and mean interharvest date, as a way to see if growth rate changes over the summer independently of temperature.  This model would include a co-variate of stem diameter and random effect of plant nested in field.


# Data pre-treatment
## Prep for option 1

1. create appropriately lagged variables.  Since shoot growth is measured in the morning, the most relevant weather events are the day before.

**TODO:** I could actually add previous days of temperature from the weather station data so I don't loose a row when I lag the shoot measurements.

```{r}
shoot.data2 <- 
  shoot.data %>% 
  group_by(shoot_id) %>% #within each shoot_id...
  arrange(date) %>% #sort by date...
  mutate_at(vars(starts_with("temp_")), lag) %>% #then move all the temperature measurements back a day
  mutate_at(c("precip_caas", "sun_hrs", "rh", "precip_mm"), lag) #and the rest of the weather
# skimr::skim(shoot.data2)
```

2. Create variable for # days post harvest and variable for start date.
```{r}
shoot.data3 <-
  shoot.data2 %>%
  mutate(day_post = day - first(day),
         start = first(day),
         mean_day = mean(day)) %>%
  ungroup()

# shoot.data3 %>% filter(day_post ==0) %>% group_by(field) %>% count(interharvest.no)
```

3. create unique IDs for plant and interharvest number nested within field
```{r}
shoot.data4 <-
  shoot.data3 %>% 
  mutate(plant_id = paste0(field, plant),
         interharvest_id = paste0(field, interharvest.no)) 
```

4. Remove NA's and outliers for growth data
```{r}
shoot.data5 <-
  shoot.data4 %>% 
  filter(!is.na(growth)) %>% 
  filter(!is.na(diameter)) %>% 
  filter(growth < 5 & growth > -5)
```

5. Remove first interharvest period for field B.  It was only 4 days, so I think data collection started in the middle of an interharvest period, making `day_post` unreliable as a co-variate for this replicate.

```{r}
# shoot.data5 %>% group_by(interharvest_id) %>% summarize(max(day_post))
shoot.data6 <- shoot.data5 %>% filter(interharvest_id != "B1")
# shoot.data6 %>% group_by(interharvest_id) %>% summarize(mean(mean_day))
```



# Analysis for daily growth rate model



## Start with full model

```{r}
temp.lmer <-
  lmer(growth ~ temp_mean + I(temp_mean^2)+ day_post + diameter + mean_day + (1|interharvest_id),
                   data = shoot.data6)
summary(temp.lmer)
```
## Does random effect matter?

```{r}
temp.lm <-
  lm(growth ~ temp_mean + I(temp_mean^2) + day_post + diameter + mean_day,
                   data = shoot.data6)
lmtest::lrtest(temp.lmer, temp.lm)
ICtab(temp.lm, temp.lmer)
```
Yes, random effect does matter.
Winner = temp.lmer

## Does mean date matter?

```{r}
temp.lmer2 <-
  lmer(growth ~ temp_mean + I(temp_mean^2) + day_post + diameter  + (1|interharvest_id),
                   data = shoot.data6)

lmtest::lrtest(temp.lmer, temp.lmer2)
ICtab(temp.lm, temp.lmer, temp.lmer2)
```
No, (interesting).
Winner = temp.lmer2

## Which fits better, qudratic or linear?
```{r}
temp.lmer3 <-
  lmer(growth ~ temp_mean + day_post + diameter  + (1|interharvest_id),
                   data = shoot.data6)
lmtest::lrtest(temp.lmer2, temp.lmer3)
ICtab(temp.lm, temp.lmer, temp.lmer2, temp.lmer3)
```
Linear fits better
winner = temp.lmer3

```{r}
summary(temp.lmer3)
Anova(temp.lmer3)
```

- linear growth declines slighly after harvest
- fatter shoots grow faster
- Significant linear effect of temperature on growth

## Look at fitted values

Uhh.. this is messy because of co-variates.  How do I get a line that represents a mean?  I guess for each temp take the mean of growth??

```{r}
fixef(temp.lmer3) -> coefs
coefs
eq <- function(x) coefs[1] + coefs[2]*x

ggplot(shoot.data6, aes(x = temp_mean, y = growth, color = day_post, size = diameter)) +
  geom_point(alpha = 0.1) +
  stat_function(fun = eq) + #not sure if this is correct.  Probably fitted to smallest diameter and 0days post harvest
  labs(x = "Mean daily temperature (ºC)",
       y = "Shoot growth (cm)")
```

# Pre-treatment for option 2, fitting lines to shoots

Fit lines to shoot height over time!

```{r}
shoot.slopes <-
  shoot.data6 %>% 
  group_by(shoot_id) %>%  #for every unique shoot
  nest() %>% 
  mutate(model = map(data, ~lm(shoot_height ~ day_post, data = .))) %>% 
  mutate(intercept = map_dbl(model, ~coef(.)[1]),
         slope = map_dbl(model, ~coef(.)[2])) %>%
  filter(!is.na(slope))
```

Calculate mean temp for each period?
plus keep diameter and field and mean harvest date?
```{r}
field.summary <-
  shoot.data6 %>% 
  group_by(shoot_id) %>% 
  summarize(mean_temp_mean = mean(temp_mean),
            diameter = mean(diameter),
            field = first(field),
            mean_day = mean(day),
            interharvest_id = first(interharvest_id)
            )
```

Join em

```{r}
shoot.summary <- left_join(shoot.slopes, field.summary)
```

model it

```{r}
m <- lm(slope ~ mean_temp_mean + diameter, data = shoot.summary)
Anova(m)
summary(m)
```
uhhhh temperature has negative effect on slope?!? the fuck?


