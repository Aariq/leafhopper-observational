---
title: "Preliminary analysis of shoot growth data"
author: "Eric R. Scott"
date: "2017-06-05"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

TODO: The distributed lag models really need **penalized** splines, which I guess aren't done automatically with "cr"

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

*Last compiled: `r Sys.Date()`*

```{r packages, message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(lme4)
library(car)
library(broom)
library(plotly)
library(here)
library(conflicted)
library(bbmle)
library(lmtest)
conflict_prefer("filter", "dplyr")
conflict_prefer("here", "here")
conflict_prefer("lag", "dplyr")
```

# Read in Data

```{r}
shootdf <- read_rds(here("data", "cleaned", "shoots.rds"))
head(shootdf)
```
`shootdf` contains

 - `date`, the date of the observation
 - `day`, day from first measurement 
 - `field`, whether it's from field A or B
 - `harvest`, did they hareves yesterday?
 - `plant`, plant ID within field.  It's the same plant ever interharvest period
 - `shoot`, shoot ID within plant.  These are different shoots each interhavest period
 - `shoot_id`, unique shoot ID in the form of f{field}-h{interhaverst.no}-p{plant}-s{shoot#}
 - `shoot_height` shoot height in cm
 - `interharvest` Which interharvest period?  Date listed is the last day of that interharvest period
 - `interharvest.no` Which interharvest period? 1-4 as character, for easier filtering and faceting in plots
 - `growth` difference from the previous day's `shoot_height`
 - `diameter` shoot diameter in (UNITS??)
 - `temp_mean`, mean daily temperature in ºC
 - `temp_max`, maximum daily temperature in ºC
 - `temp_min`, minimum daily temperature in ºC
 - `precip_caas`, precip from weather station in mm
 - `sun_hrs`, from weather station
 - `rh`, relative humidity from weather station
 - `precip_mm`, precip from rain gauge

# Purpose
Determine effects of temperature and precipitation on shoot growth.

## Experimental Design
Two fields (A and B).  10 plants in each field, 7 shoots on each plant.  Daily measurements of growth.  Shoots reset every harvest and stem diameter measured as co-variate.  Three inter-harvest periods for each site (but overlapping).  Hourly temperature measurements (converted to daily max, min, mean).

## Goal of analysis
Is there an effect of temperature on shoot growth?  Is the effect linear or quadratic (that is, does growth slow when it's too hot)?  Does shoot growth differ between the two fields.  I also have data on precipitation and "sunshine hours" which could impact shoot growth, but I'm going to start by modeling the effects of temperature.


## Measuring growth

After conversations with Collin, I think that linear growth is the most appropriate way to model growth.  There are two ways I could approach this. I think it might be wise to try both.  If they give me similar results, that's good news.


### Option 1: Daily growth rate
Daily growth rate calculated at $r = h_{t+1} - h_t$.  Then I would model growth rate as a quadratic effect of temperature.  With this method, the effect of field is, I think, confounded with interharvest period since the two fields were not harvested on the same schedule.  I also can't use interharvest period as a nested random effect because there are only two harvest periods for field B.  So, the best option is to use field-harvest as a randome effect.  The downside of this is all I can say is that harvest/fields are different.  I won't be able to say if growth rates change systematically as a funciton of harvest date, for example. I would be able to use stem diameter and day post harvest as co-variates and plant ID as a random effect.

Can I use mean harvest date as a fixed effect?  I think we decided no, but I'm not sure why.

### Option 2: Distributed lag model
I don't think this is as important for shoot growth as it is for leafhopper densities, but I'll implement it here anyways as a test.

# Distribution

```{r}
hist(shootdf$growth)
```
Growth has a really leptokurtic distribution. Also, negative growth shouldn't happen and just indicates measurement error.  I'll try creating a truncated growth variable.

```{r}
shootdf <-
  shootdf %>% 
  mutate(growth_trunc = ifelse(growth <= 0, 0.001, growth))
         
hist(shootdf$growth_trunc)

any(shootdf$growth_trunc < 0)
```

Now this variable looks maybe gamma distributed.  I'll which model diagnostics look better.
```{r}
growth <-
  lm(growth ~ 1,
     data = shootdf)
growth_trunc <- 
    glm(growth_trunc ~ 1,
          family = "Gamma",
          data = shootdf)
plot(growth)
plot(growth_trunc)
```
Not better!  Plus now it's zero-inflated.  I'll stick with the gaussian.

# Analysis for effect of temperature and precip on daily growth rate

## Start with full model

```{r}
growth.lmer <-
  lmer(growth ~ poly(temp_lag1, 2, raw = TRUE)*poly(precip_lag1, 2, raw = TRUE) + day_post + diameter + (1|interharvest_id),
       data = shootdf)
```

## Does random effect matter?

```{r}
growth.lm <-
  lm(growth ~ poly(temp_lag1, 2, raw = TRUE)*poly(precip_lag1, 2, raw = TRUE) + day_post + diameter,
                   data = shootdf)
ICtab(growth.lm, growth.lmer)
```
No, random effect doesn't matter.  Winner is growth.lm

## Do co-variates matter?

```{r}
growth.lm2 <-
  lm(growth ~ poly(temp_lag1, 2, raw = TRUE)*poly(precip_lag1, 2, raw = TRUE) + day_post,
                   data = shootdf)
growth.lm3 <-
  lm(growth ~ poly(temp_lag1, 2, raw = TRUE)*poly(precip_lag1, 2, raw = TRUE)  + diameter,
                   data = shootdf)
ICtab(growth.lm, growth.lm2, growth.lm3)
```
Yes, keep both co-variates

## Which fits better, quadratic or linear?

```{r}
growth.lm4 <-
  lm(growth ~ temp_lag1 * poly(precip_lag1, 2, raw = TRUE) + day_post + diameter,
                   data = shootdf)
growth.lm5 <-
  lm(growth ~ poly(temp_lag1, 2, raw = TRUE) * precip_lag1 + day_post + diameter,
                   data = shootdf)
growth.lm6 <-
  lm(growth ~ temp_lag1 * precip_lag1 + day_post + diameter,
                   data = shootdf)
ICtab(growth.lm, growth.lm4, growth.lm5, growth.lm6)
```

Both quadratic fits best

## Is there an interaction?

```{r}
growth.lm7 <-
  lm(growth ~ poly(temp_lag1, 2, raw = TRUE) + poly(precip_lag1, 2, raw = TRUE) + day_post + diameter,
                   data = shootdf)
ICtab(growth.lm, growth.lm7)
```
Yes.

```{r}
growth.lm.a <-
  lm(growth ~ -1 +poly(temp_lag1, 2, raw = TRUE)*poly(precip_lag1, 2, raw = TRUE) + day_post + diameter,
                   data = shootdf)
summary(growth.lm.a)

Anova(growth.lm)
```


Hoo boy, this is not easy to interpret.  I think the interaction was a bad idea.

```{r}
growth.lm8 <-
  lm(growth ~ temp_lag1 + poly(precip_lag1, 2, raw = TRUE) + day_post + diameter,
                   data = shootdf)

growth.lm9 <-
  lm(growth ~ poly(temp_lag1, 2, raw = TRUE) + precip_lag1 + day_post + diameter,
                   data = shootdf)

growth.lm10 <-
  lm(growth ~ temp_lag1 + precip_lag1 + day_post + diameter,
                   data = shootdf)

ICtab(growth.lm7, growth.lm8, growth.lm9, growth.lm10)
```

Ok, wow, there really is an interaction and a quadratic effect??


## Look at fitted values
I'm not sure how to get a confidence interval for the fitted line.  The SE provided by `Effect()` seems wrong.
```{r}
library(effects) 

ee.temp <- Effect("temp_lag1", growth.lm) 

ggplot(shootdf) +
  geom_point(aes(x = temp_lag1, y = growth), alpha = 0.1) +
  geom_line(data = as.data.frame(ee.temp), aes(x = temp_lag1, y = fit)) +
  geom_ribbon(data = as.data.frame(ee.temp), colour = NA, alpha = 0.1, aes(x = temp_lag1, ymin = lower, ymax = upper)) +

  labs(x = "Mean temperature of previous day (ºC)",
       y = "Shoot growth (cm)") +
  theme_bw()
```
```{r}
ee.precip <- Effect("precip_lag1", growth.lm) 

ggplot(shootdf) +
  geom_point(aes(x = precip_lag1, y = growth), alpha = 0.1) +
  geom_line(data = as.data.frame(ee.precip), aes(x = precip_lag1, y = fit)) +

  labs(x = "precip of previous day (mm)",
       y = "Shoot growth (cm)")
```




# Distributed Lag Model

```{r}
library(dlnm)
```

## Construct lagged variables

Because or the complex design, I need to supply `crossbasis` with a matrix of pre-constructed lagged temperature variables. 


```{r}
temp_mat <-
  shootdf %>%
  ungroup() %>%
  select(starts_with("temp")) %>% 
  as.matrix()
```

Then I construct the cross-basis variable using a penalized cubic spline for the lag kernel and either a polynomial or linear relationship to the response variable.  For the cubic spline, I reduced the degrees of freedom to 6 because it was causing problems with `lmer` with the default.

```{r}
temp_k <-
  crossbasis(
  x = temp_mat,
  argvar = list(fun = "poly", degree = 2),
  arglag = list(fun = "cr", df = 6)
  )

temp_k_lin <-
  crossbasis(
    x = temp_mat,
    argvar = list(fun = "lin"),
    arglag = list(fun = "cr", df = 6)
  )
summary(temp_k)
summary(temp_k_lin)
```





# Distributed lag model for precip

Because why not?

## Make lagged precip variable

```{r}
precip_mat <-
  shootdf %>%
  ungroup() %>%
  select(starts_with("precip")) %>% 
  as.matrix()
```

Then I construct the cross-basis variable using a penalized cubic spline for the lag kernel and either a polynomial or linear relationship to the response variable.  For the cubic spline, I reduced the degrees of freedom to 6 because it was causing problems with `lmer` with the default.

```{r}
precip_k <-
  crossbasis(
  x = precip_mat,
  argvar = list(fun = "poly", degree = 2),
  arglag = list(fun = "cr", df = 6)
  )

precip_k_lin <-
  crossbasis(
    x = precip_mat,
    argvar = list(fun = "lin"),
    arglag = list(fun = "cr", df = 6)
  )
summary(precip_k)
summary(precip_k_lin)
```

## Fit full model

```{r}
precip_lag_lmer <-
  lmer(growth ~ precip_k + day_post + diameter + (1|interharvest_id),
                   data = shootdf)
```

## Does random effect matter?

```{r}
precip_lag_lm <-
  lm(growth ~ precip_k + day_post + diameter,
                   data = shootdf)

ICtab(precip_lag_lmer, precip_lag_lm)
```
Keep full model



## Linear or quadratic effect of precip?

```{r}
precip_lag_lmer2 <-
  lmer(growth ~ precip_k_lin + day_post + diameter + (1|interharvest_id),
                   data = shootdf)
ICtab(precip_lag_lmer, precip_lag_lmer2)
```
Quadratic fits better in this case.

```{r}
summary(precip_lag_lmer)
Anova(precip_lag_lmer)
```
```{r}
pred.precip <- crosspred(
  precip_k, #the lagged predictor variable
  precip_lag_lmer, #the glm model
  # at=0:20, #what values of PM10 to evaluate at
  bylag=0.2, #how fine to increment the lag space.  Small number makes smoother
  cumul=TRUE #"incremental cumulative associations along lags are also predicted"
  )
```

```{r}
plot(pred.precip, "contour",
     ylab = "lag (days)",
     xlab = "precipitation (mm)")
```

Strongest effect of a 3 day lag.  Low rain is good for growth, too much rain bad for growth

# Include both temp and precip in the same model

```{r}
w_lmer <- 
    lmer(growth ~ precip_k + temp_k + day_post + diameter + (1|interharvest_id),
         data = shootdf)
```
```{r}
w_lm <-     
  lm(growth ~ precip_k + temp_k + day_post + diameter,
         data = shootdf)
ICtab(w_lm, w_lmer)
```

Ok, now the random effect isn't significant

Check co-variates
```{r}
w_lm2 <-     
  lm(growth ~ precip_k + temp_k + day_post,
         data = shootdf)

w_lm3 <-     
  lm(growth ~ precip_k + temp_k + diameter,
         data = shootdf)

w_lm4 <-     
  lm(growth ~ precip_k + temp_k,
         data = shootdf)

ICtab(w_lm, w_lm2, w_lm3, w_lm4)
```
Co-variates all matter

check main effects shape

```{r}
w_lm5 <-     
  lm(growth ~ precip_k_lin + temp_k + day_post + diameter,
         data = shootdf)

w_lm6 <-     
  lm(growth ~ precip_k + temp_k_lin + day_post + diameter,
         data = shootdf)
w_lm7 <-     
  lm(growth ~ precip_k_lin + temp_k_lin + day_post + diameter,
         data = shootdf)

ICtab(w_lm, w_lm6, w_lm7)
```
Both quadratic

Test for significance of main effects

```{r}
w_lm8 <-     
  lm(growth ~ temp_k + day_post + diameter,
         data = shootdf)

w_lm9 <-     
  lm(growth ~ precip_k + day_post + diameter,
         data = shootdf)

w_lm10 <-     
  lm(growth ~ day_post + diameter,
         data = shootdf)

ICtab(w_lm, w_lm8, w_lm9, w_lm10)
```

Both significant

is there an interaction?

```{r}
w_lm11 <-     
  lm(growth ~ precip_k*temp_k + day_post + diameter,
         data = shootdf)
ICtab(w_lm, w_lm11)
```
ok, no.

```{r}
pred.temp <- crosspred(
  temp_k, #the lagged predictor variable
  w_lm, #the glm model
  # at=0:20, #what values of PM10 to evaluate at
  bylag=0.2, #how fine to increment the lag space.  Small number makes smoother
  cumul=TRUE #"incremental cumulative associations along lags are also predicted"
  )

pred.precip <- crosspred(
  precip_k, #the lagged predictor variable
  w_lm, #the glm model
  # at=0:20, #what values of PM10 to evaluate at
  bylag=0.2, #how fine to increment the lag space.  Small number makes smoother
  cumul=TRUE #"incremental cumulative associations along lags are also predicted"
  )
```

```{r}
plot(pred.temp, "contour",
     ylab = "lag (days)",
     xlab = "mean temperature (ºC)")
```
```{r}
plot(pred.precip, "contour",
     ylab = "lag (days)",
     xlab = "precip (mm)")
```

When I account for temperature and precip in the same model, now high precip is good for plants.

# Conclusion

There is a significant effect of temperature on tea shoot growth.  A distributed lag model shows the same thing, and is not really conceptually necessary for this analysis.  I should probably only report the results of the LMER model.

For precipitation, a 1-day lag has no effect on growth.  The distributed lag model is highly significant though showing a quadratic effect of prcip 3 days ago.