---
title: "EDA and descriptive figures"
author: "Eric R. Scott"
date: "2022-03-26"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

*Last compiled: `r Sys.Date()`*

```{r packages, include=FALSE}
library(tidyverse)
library(here)
library(patchwork)
library(cowplot)
library(scales)
library(mgcv)
library(conflicted)
conflict_prefer("filter", "dplyr")
```

# Purpose

Make a plot that shows leafhopper densities over time with harvests and maybe weather.

Also a supplementary plot showing concurvity of temp and precip. (I guess I do a geom_smooth()?)

# Load Data

```{r data, echo=TRUE}
df <- read_rds(here("data", "cleaned", "hopper-weather.rds"))
```


# Summary tables

```{r}
df %>% 
  group_by(field, interharvest.no) %>% 
  summarize(length = last(date) - first(date),
            mean_temp = mean(temp_mean),
            mean_precip = mean(precip_mm),
            num_rainy = sum(precip_mm >0)/n(),
            median_precip = median(precip_mm),
            mean_density = mean(hoppers/n_leaves))

df %>% 
    summarize(length = last(date) - first(date),
            mean_temp = mean(temp_mean),
            mean_precip = mean(precip_mm),
            max_precip = max(precip_mm),
            mean_density = mean(hoppers/n_leaves))
  
```

# Leafhopper Density Plot

## Summarize data for plotting

```{r}
plotdf <- df %>% 
  group_by(date, field) %>% 
  summarize(density = mean(hoppers / n_leaves),
            interharvest.no = first(interharvest.no)) %>% 
  mutate(harvest = paste0(field, interharvest.no)) %>% 
  filter(harvest != "A4")
```


## Plot

add lines/colors for harvests?
add panel for temp
add panel for precip

```{r}
densityplot <-
  ggplot(plotdf, aes(x = date, y = density, group = field, color = harvest)) + 
  geom_line(size = 1, lineend = "round") +
  theme_bw() +
  labs(x = "Date", y = "Leafhopper Density (insects/leaf)", color = "Harvest") +
  scale_x_date(date_breaks = "3 days", labels = label_date(format = "%b %d")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


```{r}
ggplot(df, aes(x = date, y = hoppers/n_leaves, group = plant)) +
  geom_line(alpha = 0.1) +
  geom_line(data = plotdf, aes(y = density, group = field, color = harvest), size = 1) +
  theme_bw() +
  labs(x = "Date", y = "Leafhopper Density (insects/leaf)", color = "Harvest") +
  scale_x_date(date_breaks = "1 week", labels = label_date(format = "%b %d"))
# ggsave("test.png")
```

# Figure 1

```{r}
weatherdf <- 
  df %>% group_by(date) %>% 
  summarize(precip_mm = first(precip_mm),
            temp_mean = first(temp_mean),
            temp_min = first(temp_min),
            temp_max = first(temp_max))

precip_plot <- 
  ggplot(weatherdf, aes(x = date, y = precip_mm)) +
  geom_col(fill = "darkblue") +
  theme_bw() +
  scale_y_continuous("Precipitation (mm)") +
  scale_x_date(date_breaks = "3 days", labels = label_date(format = "%b %d")) +
  theme(axis.text.x.bottom = element_blank(),
        axis.title.x.bottom = element_blank())

temp_plot <-
  ggplot(weatherdf, aes(x = date)) +
  geom_line(aes(y = temp_mean), color = "red") +
  geom_line(aes(y = temp_min), color = "red", lty = "dashed") +
  geom_line(aes(y = temp_max), color = "red", lty = "dashed") +
  theme_bw() +
  scale_y_continuous("Temperature (ºC)") +
  scale_x_date(date_breaks = "3 days", labels = label_date(format = "%b %d")) +
  theme(axis.text.x.bottom = element_blank(),
        axis.title.x.bottom = element_blank())
```
```{r}
plot1 <- precip_plot/temp_plot/densityplot + plot_layout(heights = c(2,2,4)) + plot_annotation(tag_levels = "A")
plot1
save_plot(here("figs", "exploratory.png"), plot1, base_height = 7, base_aspect_ratio = 1.25)
```


# Correlation / concurvity supplementary plot

Concurvity estimated from GAM with both temp and precip worst was 0.99

```{r}
weatherdf
concurvity_p <- 
  ggplot(weatherdf, aes(y = temp_mean, x = precip_mm)) + 
  geom_point(alpha = 0.5) + 
  geom_smooth(method = "gam", level = 0.95) +
  labs(x = "Precipitation (mm)", y = "Mean Temperature (ºC)") +
  theme_bw()
concurvity_p
# save_plot(here("figs", "plotS1.png"), concurvity_p)
```

```{r}

test <-gam(temp_mean ~ s(precip_mm, bs = "cs"), data = weatherdf)
gam.check(test)
anova.gam(test)
plot.gam(test,residuals = TRUE, cex = 4, shift = coef(test)[1])
```

not sure why different

# Descriptives

```{r}
weatherdf %>% 
  summarize(temp_grandmean = mean(temp_mean),
            temp_sd = sd(temp_mean),
            precip_mean = mean(precip_mm),
            precip_sd = sd(precip_mm),
            rainy_days_percent = sum(precip_mm >0)/n())
```

```{r}
df %>% 
  summarize(hopper_density = mean(hoppers/n_leaves),
            hopper_density_sd = sd(hoppers/n_leaves))
```


