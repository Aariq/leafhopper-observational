---
title: "Distributed Lag Model for Shoot Growth"
author: "Eric R. Scott"
date: "2020-01-15"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

#TODO

- include conversion to factors in wrangling, not in this doc.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 4)
```

*Last compiled: `r Sys.Date()`*

# Packages

```{r packages, message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(conflicted)
library(mgcv)
library(dlnm)
library(glue)
library(colorspace)
library(cowplot)
library(patchwork)

conflict_prefer("filter", "dplyr")
conflict_prefer("here", "here")
conflict_prefer("lag", "dplyr")
conflict_prefer("select", "dplyr")
```

# Goal

This analysis is based on Gasparrini A, Scheipl F, Armstrong B, Kenward MG (2017) A penalized framework for distributed lag non-linear models. Biometrics 73:938–948. doi: 10.1111/biom.12645.  Specifically, it is based on `ex1_01.int.R` provided in their code.  This "internal" method for distributed lag models takes full(?) advantage of built in features of `gam`s.

The goal is to model the effects of temperature and precipitation on plant growth allowing for variable shape through time (lag) and across values of the predictor using a two-dimensional smoothing function called a cross-basis function. In an ideal world, the penalized spline would be the shrinkage version (bs = "cs"), but that isn't available in the crossbasis smooth constructor provided by `dlnm`, so this uses regular penalized cubic regression splines.

# Read in Data

```{r}
shootdf <- read_rds(here("data", "cleaned", "shoots.rds"))

shootdf <- shootdf %>% 
  separate(shoot_id, into = c("field", "harvest", "plant", "shoot"),
           remove = FALSE, sep = "-") %>% 
  mutate(plant = as.factor(paste0(field, plant)), 
         interharvest_id = as.factor(interharvest_id)) %>% 
  filter(!is.na(precip_lag15)) #get rid of shoots that don't have 15 days of data
head(shootdf)
```

Variables I'll be using:

- `growth` (response): a linear growth rate in cm ($h_t - h_{t-1}$)
- `diameter` (co-variate): stem diameter in mm
- `day_post` (co-variate): number of days post-harvest.  Shoots are "re-set" every harvest
- `temp_*` (predictor): I'm using mean temperature lagged out to 14 days to make a cross-basis function
- `precip_*` (predictor): precipitation lagged out to 14 days
- `plant` (random effect): which plant was the shoot on
- `interharvest_id` (random effect): combination of field ID and which interharvest period it was.  Each field x interharvest period experienced a unique climate history because harvests were not synchronized between the two fields.

# Visual inspection

```{r}
ggplot(shootdf, aes(x=growth)) + geom_histogram(bins = 30)
```


# Distributed Lag Model: "internal" method

## Setup

Create matrices for temperature, precip, and lag.

```{r}
Q_temp <-
  shootdf %>% 
  select(starts_with("temp")) %>% 
  as.matrix()

Q_precip <-
  shootdf %>%
  select(starts_with("precip")) %>% 
  as.matrix()

L <- matrix(0:(ncol(Q_temp) - 1), nrow(Q_temp), ncol(Q_temp), byrow = TRUE)
# head(L)
```

## Build the GAM

```{r}
m_shoots <- 
  gam(growth ~ 
        #cross-basis function for temperature
        s(Q_temp, L,
          bs = "cb",
          k = c(5, 7),
          xt = list(bs = "cr")
          ) +
        #cross-basis function for precipitation
        s(Q_precip, L,
          bs = "cb",
          k = c(5, 7),
          xt = list(bs = "cr")
          ) +
        s(day_post, bs = "cs") + s(diameter, bs = "cs") + #co-variates
        s(interharvest_id, bs = "re") + s(plant, bs = "re"), #random effects
      data = shootdf,
      family = scat, #because residuals are very leptokurtic w/ gaussian
      # gamma = 1.2, #values above 1 make smoother.  Borrowed from Teller et al.
      method = "REML")
```


## Inspect the GAM

```{r eval = FALSE}
gam.check(m_shoots)
# summary(m_shoots)
m_shoots$converged
```

GAM converges, number of knots seems a bit high for temperature and precip, but that's fine

```{r eval = FALSE}
concurvity(m_shoots, full = TRUE)
```

This currently errors, but previous versions of the analysis with more constrained relationships between weather and growth showed that both precip and temperature have potential problems with concurvity.

Precip and temp are concurve(?) meaning they might be redundant in the model.  This makes sense as temperature and precip are generally correlated to some extent.


# Dealing with Concurvity:

I think its best if I fit two GAMs---one with just temperature and one with just precipitation.  Then I will compete those with AIC and choose the model that is best.  I'll report the stuff about concurvity

```{r}
m_shoot_temp <- 
  gam(growth ~ 
        #cross-basis function for temperature
        s(Q_temp, L,
          bs = "cb",
          k = c(5, 7),
          xt = list(bs = "cr")
          ) +
        s(day_post, bs = "cs") + s(diameter, bs = "cs") + #co-variates
        s(interharvest_id, bs = "re") + s(plant, bs = "re"), #random effects
      data = shootdf,
      family = scat, #because residuals are very leptokurtic w/ gaussian
      # gamma = 1.2, #values above 1 make smoother.  Borrowed from Teller et al.
      method = "REML")

m_shoot_precip <- 
  gam(growth ~ 
        #cross-basis function for precipitation
        s(Q_precip, L,
          bs = "cb",
          k = c(5, 7),
          xt = list(bs = "cr")
          ) +
        s(day_post, bs = "cs") + s(diameter, bs = "cs") + #co-variates
        s(interharvest_id, bs = "re") + s(plant, bs = "re"), #random effects
      data = shootdf,
      family = scat, #because residuals are very leptokurtic w/ gaussian
      # gamma = 1.2, #values above 1 make smoother.  Borrowed from Teller et al.
      method = "REML")
```

```{r}
AIC(m_shoot_temp, m_shoot_precip)
bbmle::ICtab(m_shoot_temp, m_shoot_precip)
```

# Temperature only model

The temperature only model wins with lowest AIC.

## Significance test

```{r}
anova(m_shoot_temp)
```

Significant effects of lagged temperature, days post harvest, stem diameter, and plant ID.

## Predictions and plots

### Regular smooths for covariates

```{r include=FALSE}
#pull plot data
shoot_pd <- 
  plot(m_shoot_temp, seWithMean = TRUE, shift = coef(m_shoot_temp)[1])

dph_t <- shoot_pd[[2]]
dia_t <- shoot_pd[[3]]
```

```{r}
# make plots
dph_t_plot <-
  tibble(x = dph_t$x, se = dph_t$se, y = dph_t$fit + coef(m_shoot_temp)[1]) %>% 
  ggplot(aes(x, y)) + 
  geom_line() +
  geom_ribbon(aes(ymin = y-se, ymax = y+se), alpha = 0.2) +
  geom_rug(aes(x = raw, y =y), data = tibble(raw = dph_t$raw, y = 0), sides = "b") +
  scale_y_continuous("Shoot growth (cm/day)", limits = c(0,0.6)) +
  scale_x_continuous("Days post harvest") +
  theme_bw()


dia_t_plot <- 
  tibble(x = dia_t$x, se = dia_t$se, y = dia_t$fit + coef(m_shoot_temp)[1]) %>% 
  ggplot(aes(x, y)) + 
  geom_line() +
  geom_ribbon(aes(ymin = y-se, ymax = y+se), alpha = 0.2) +
  geom_rug(aes(x = raw, y =y), data = tibble(raw = dia_t$raw, y = 0),
           sides = "b", alpha = 0.1) +
  scale_y_continuous("Shoot growth (cm/day)", limits = c(0,0.6)) +
  scale_x_continuous("Diameter (mm)") +
  theme_bw()

dph_t_plot + dia_t_plot
```

Shoots with larger diameters grow faster.  Shoot growth rates vary through time in a more complex manner with the fastest growth happening about 10 days post harvest and the slowest growth around 25 days post harvest.

### Partial effects plot for cross-basis function

#### Make newdata

```{r}
testvals <- seq(min(Q_temp), max(Q_temp), length.out = 200)
Q_temp_new <- matrix(mean(shootdf$temp_mean), nrow = length(testvals), ncol = ncol(Q_temp))
L_new <- L[1:length(testvals), ]
day_post_new <- rep(mean(shootdf$day_post), length(testvals))
diameter_new <- rep(mean(shootdf$diameter), length(testvals))
interharvest_id_new <- rep("newlevel", length(testvals))
plant_new <- rep("newlevel", length(testvals))
```

#### predict loops

```{r}
resp_t <- array(dim = c(length(testvals), ncol(Q_temp_new)))
rownames(resp_t) <- testvals

#loop through columns of matrix, replace with testvals, predict fitted.
for(i in 1:ncol(Q_temp_new)) {
  P1_i <- Q_temp_new
  P1_i[, i] <- testvals
  resp_t[, i] <-
    suppressWarnings( #new levels of random effects are on purpose
      predict(
        m_shoot_temp,
        newdata = list(
          Q_temp = P1_i,
          L = L_new,
          day_post = day_post_new,
          diameter = diameter_new,
          interharvest_id = interharvest_id_new,
          plant = plant_new
        ),
        type = "response"
      )
    )
}

which(resp_t == min(resp_t), arr.ind = TRUE)
resp_t[1,1]

which(resp_t == max(resp_t), arr.ind = TRUE)
resp_t[54,16]
```

#### Make the plot

Raster version:

```{r}
st_pd <-
  resp_t %>% 
  as_tibble(rownames = "x") %>% 
  pivot_longer(cols = starts_with("V"),
               names_to = "lag", names_prefix = "V", values_to = "fitted") %>% 
  mutate(lag = as.double(lag) - 1, x = as.double(x)) 

shoot_temp_raster <-
  ggplot(st_pd, aes(x = x, y = lag, z = fitted, fill = fitted)) +
  geom_raster(interpolate = TRUE) +
  geom_contour(color = "black", alpha = 0.2) +
  scale_fill_viridis_c("Shoot growth \n(cm/day)", option = "A", limits = c(0.25, 0.45)) + 
  scale_y_continuous("Lag (days)", expand = c(0,0)) + 
  scale_x_continuous("Temperature (ºC)", expand = c(0,0)) +
  theme(text = element_text(size = 14))
save_plot(here("figs", "shoot_temp_raster.png"), shoot_temp_raster)
```

Contour version:

```{r}
shoot_temp_contour <-
  ggplot(st_pd, aes(x = x, y = lag, z = fitted, fill = fitted)) +
  geom_contour_filled(aes(fill = stat(level)), breaks = seq(0.25, 0.45, by = 0.02))  +
  scale_fill_viridis_d("Shoot growth \n(cm/day)", option = "A", drop = FALSE) +
  scale_y_continuous("Lag (days)", expand = c(0,0)) + 
  scale_x_continuous("Temperature (ºC)", expand = c(0,0)) +
  guides(fill = guide_colorsteps(show.limits = TRUE, barheight = unit(0.3, "npc"))) +
  theme(text = element_text(size = 14))
save_plot(here("figs", "shoot_temp_contour.png"), shoot_temp_contour)
```

Multipanel plot:

```{r}
layout <-
"
AABB
AABB
CCCC
CCCC
CCCC
CCCC
"

temp_multi <-
  dph_t_plot +
  dia_t_plot +
  # shoot_temp_contour +
  shoot_temp_raster +
  plot_layout(design = layout) +
  plot_annotation(tag_levels = "A") 

save_plot(here("figs", "shoot_temp_multi.png"), 
          temp_multi,
          ncol = 1, base_height = 6, base_asp = 1.1)
```

# Precip

```{r}
anova.gam(m_shoot_precip)
```

```{r}
#get data
shoot_pd <- plot.gam(m_shoot_precip, seWithMean = TRUE, shift = coef(m_shoot_precip)[1])

dph_p <- shoot_pd[[2]]
dia_p <- shoot_pd[[3]]
```

NOTE: consider combining with other covariate plots from the temperature model.  E.g. two lines on the same plot.

```{r}
#make plots 
dia_p_plot <- 
  tibble(x = dia_p$x, se = dia_p$se, y = dia_p$fit + coef(m_shoot_precip)[1]) %>% 
  ggplot(aes(x, y)) + 
  geom_line() +
  geom_ribbon(aes(ymin = y-se, ymax = y+se), alpha = 0.2) +
  geom_rug(aes(x = raw, y =y), data = tibble(raw = dia_p$raw, y = 0),
           sides = "b", alpha = 0.1) +
  scale_y_continuous("Shoot growth (cm/day)", limits = c(0,0.6)) +
  scale_x_continuous("Diameter (mm)") +
  theme_bw()

dph_p_plot <- 
  tibble(x = dph_p$x, se = dph_p$se, y = dph_p$fit + coef(m_shoot_precip)[1]) %>% 
  ggplot(aes(x, y)) + 
  geom_line() +
  geom_ribbon(aes(ymin = y-se, ymax = y+se), alpha = 0.2) +
  geom_rug(aes(x = raw, y =y), data = tibble(raw = dph_p$raw, y = 0),
           sides = "b", alpha = 0.1) +
  scale_y_continuous("Shoot growth (cm/day)", limits = c(0,0.6)) +
  scale_x_continuous("Days post harvest") +
  theme_bw()

dph_p_plot + dia_p_plot
```

### Partial effects plot for cross-basis function

#### Make newdata

```{r}
testvals <- seq(min(Q_precip), max(Q_precip), length.out = 200)
Q_precip_new <- matrix(mean(shootdf$precip_mm), nrow = length(testvals), ncol = ncol(Q_precip))
L_new <- L[1:length(testvals), ]
day_post_new <- rep(mean(shootdf$day_post), length(testvals))
diameter_new <- rep(mean(shootdf$diameter), length(testvals))
interharvest_id_new <- rep("newlevel", length(testvals))
plant_new <- rep("newlevel", length(testvals))
```

#### predict loops

```{r}
resp_p <- array(dim = c(length(testvals), ncol(Q_precip_new)))
rownames(resp_p) <- testvals

#loop through columns of matrix, replace with testvals, predict fitted.
for(i in 1:ncol(Q_precip_new)) {
  P1_i <- Q_precip_new
  P1_i[, i] <- testvals
  resp_p[, i] <-
    suppressWarnings( #new levels of random effects are on purpose
      predict(
        m_shoot_precip,
        newdata = list(
          Q_precip = P1_i,
          L = L_new,
          day_post = day_post_new,
          diameter = diameter_new,
          interharvest_id = interharvest_id_new,
          plant = plant_new
        ),
        type = "response"
      )
    )
}

which(resp_p == min(resp_p), arr.ind = TRUE)
resp_p[200, 1, drop = FALSE]

which(resp_p == max(resp_p), arr.ind = TRUE)
resp_p[37, 4, drop = FALSE]
```

#### Make the plot

Raster version:

```{r}
sp_pd <-
  resp_p %>%
  as_tibble(rownames = "x") %>%
  pivot_longer(
    cols = starts_with("V"),
    names_to = "lag",
    names_prefix = "V",
    values_to = "fitted"
  ) %>%
  mutate(lag = as.double(lag) - 1, x = as.double(x)) 

shoot_precip_raster <-
  ggplot(sp_pd, aes(x = x, y = lag, z = fitted, fill = fitted)) +
  geom_raster(interpolate = TRUE) +
  geom_contour(color = "black", alpha = 0.2) +
  scale_fill_viridis_c("Shoot growth \n(cm/day)", option = "A", limits = c(0.25, 0.45)) + 
  scale_y_continuous("Lag (days)", expand = c(0,0)) + 
  scale_x_continuous("Precipitation (mm)", expand = c(0,0)) +
  theme(text = element_text(size = 14)) 
save_plot(here("figs", "shoot_precip_raster.png"), shoot_precip_raster)
```

Contour version:

```{r}
shoot_precip_contour <-
  ggplot(sp_pd, aes(x = x, y = lag, z = fitted, fill = fitted)) +
  geom_contour_filled(aes(fill = stat(level)), breaks = seq(0.25, 0.45, by = 0.02))  +
  scale_fill_viridis_d("Shoot growth \n(cm/day)", option = "A", drop = FALSE) +
  scale_y_continuous("Lag (days)", expand = c(0,0)) + 
  scale_x_continuous("Precipitation (mm)", expand = c(0,0)) +
  guides(fill = guide_colorsteps(show.limits = TRUE, barheight = unit(0.2, "npc"))) +
  theme(text = element_text(size = 14))
save_plot(here("figs", "shoot_precip_contour.png"), shoot_precip_contour)
```


Multipanel plot:

```{r}
precip_multi <-
  dph_p_plot +
  dia_p_plot +
  # shoot_precip_contour +
  shoot_precip_raster +
  plot_layout(design = layout) +
  plot_annotation(tag_levels = "A") 

save_plot(here("figs", "shoot_precip_multi.png"), 
          precip_multi,
          ncol = 1, base_height = 6, base_asp = 1.1)
```

# Alternate plot layouts


## Elizabeth's suggestion:

Combine raster plots

```{r}
shoot_cbs <-
  shoot_precip_raster + 
  shoot_temp_raster +
  plot_layout(guide = "collect") + 
  plot_annotation(tag_levels = "A")
save_plot(here("figs", "shoot_crossbasis.png"), shoot_cbs, ncol = 2, nrow = 1, base_asp = 1.2)
```

And combine co-variate plots

```{r}
dph_both <-
  bind_rows(Precipitation = dph_p_plot$data, Temperature = dph_t_plot$data, .id = "predictor")
dph_both_raw <-
  bind_rows(Precipitation = tibble(raw = dph_p$raw, y = 0),
            Temperature = tibble(raw = dph_t$raw, y = 0),
            .id = "predictor")

dph_both_plot <-
  ggplot(dph_both, aes(x, y, color = predictor)) + 
  geom_line() +
  geom_ribbon(aes(ymin = y-se, ymax = y+se, group = predictor), alpha = 0.2, color = NA) +
  geom_rug(aes(x = raw, y =y), data = dph_both_raw,
           sides = "b", alpha = 0.1, color = "black") +
  scale_y_continuous("Shoot growth (cm/day)", limits = c(0,0.6)) +
  scale_x_continuous("Days post harvest") +
  scale_color_manual("Model", values = c("Precipitation" = "blue", "Temperature" = "red")) +
  theme_bw()
dph_both_plot
```

```{r}
dia_both <-
  bind_rows(Precipitation = dia_p_plot$data, Temperature = dia_t_plot$data, .id = "predictor")
dia_both_raw <-
  bind_rows(Precipitation = tibble(raw = dia_p$raw, y = 0),
            Temperature = tibble(raw = dia_t$raw, y = 0),
            .id = "predictor")

dia_both_plot <-
  ggplot(dia_both, aes(x, y, color = predictor)) + 
  geom_line() +
  geom_ribbon(aes(ymin = y-se, ymax = y+se, group = predictor), alpha = 0.2, color = NA) +
  geom_rug(aes(x = raw, y =y), data = dia_both_raw,
           sides = "b", alpha = 0.1, color = "black") +
  scale_y_continuous("Shoot growth (cm/day)", limits = c(0,0.6)) +
  scale_x_continuous("Diameter (mm)") +
  scale_color_manual("Model", values = c("Precipitation" = "blue", "Temperature" = "red")) +
  theme_bw()
dia_both_plot
```
```{r}
covars <-
  dia_both_plot + 
  (dph_both_plot +
     theme(axis.title.y = element_blank(),
           axis.text.y = element_blank(),
           axis.ticks.y = element_blank())) + 
  plot_layout(guides = "collect") + plot_annotation(tag_levels = "A")
```

```{r}
save_plot(here("figs", "shoot_covariates.png"), covars, ncol = 2, nrow = 1, base_asp = 1.2)
```

