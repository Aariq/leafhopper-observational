---
title: "Distributed Lag Model for Shoot Growth"
author: "Eric R. Scott"
date: "2020-01-15"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 4)
```

*Last compiled: `r Sys.Date()`*

# Packages

```{r packages, message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(conflicted)
library(mgcv)
library(dlnm)
library(glue)
library(colorspace)
library(patchwork)
library(bbmle)

conflict_prefer("filter", "dplyr")
conflict_prefer("here", "here")
conflict_prefer("lag", "dplyr")
conflict_prefer("select", "dplyr")

source(here("analysis", "functions.R"))
```

# Goal

This analysis is based on Gasparrini A, Scheipl F, Armstrong B, Kenward MG (2017) A penalized framework for distributed lag non-linear models. Biometrics 73:938–948. doi: 10.1111/biom.12645.  Specifically, it is based on `ex1_01.int.R` provided in their code.  This "internal" method for distributed lag models takes full(?) advantage of built in features of `gam`s.

The goal is to model the effects of temperature and precipitation on plant growth allowing for variable shape through time (lag) and across values of the predictor using a two-dimensional smoothing function called a cross-basis function. In an ideal world, the penalized spline would be the shrinkage version (bs = "cs"), but that isn't available in the crossbasis smooth constructor provided by `dlnm`, so this uses regular penalized cubic regression splines.

# Read in Data

```{r}
shootdf <- read_rds(here("data", "cleaned", "shoots.rds"))
```

Variables I'll be using:

- `growth` (response): a linear growth rate in cm ($h_t - h_{t-1}$)
- `diameter` (co-variate): stem diameter in mm
- `day_post` (co-variate): number of days post-harvest.  Shoots are "re-set" every harvest
- `temp_*` (predictor): I'm using mean temperature lagged out to 14 days to make a cross-basis function
- `precip_*` (predictor): precipitation lagged out to 14 days
- `plant` (random effect): which plant was the shoot on
- `interharvest_id` (random effect): combination of field ID and which interharvest period it was.  Each field x interharvest period experienced a unique climate history because harvests were not synchronized between the two fields.

# Visual inspection

```{r}
ggplot(shootdf, aes(x=growth)) + geom_histogram(bins = 30)
```


# Distributed Lag Model: "internal" method

## Setup

Create matrices for temperature, precip, and lag.  Zero days lag doesn't make sense since measurements were taken in the morning.  Remove those by only using variables with "lag" in the name.

```{r}
Q_temp <-
  shootdf %>% 
  select(starts_with("temp_lag")) %>% 
  as.matrix()

Q_min_temp <-
  shootdf %>% 
  select(starts_with("temp_min_lag")) %>% 
  as.matrix()

Q_max_temp <-
  shootdf %>% 
  select(starts_with("temp_max_lag")) %>% 
  as.matrix()

Q_precip <-
  shootdf %>%
  select(starts_with("precip_lag")) %>% 
  as.matrix()

L <-
  shootdf %>% 
  select(starts_with("L")) %>% 
  as.matrix()
# head(L)
```

## Fit cross-basis GAMs

```{r}
m_shoot_temp <- 
  gam(growth ~ 
        #cross-basis function for temperature
        s(Q_temp, L,
          bs = "cb",
          k = c(5, 7),
          xt = list(bs = "cr")
          ) +
        s(day_post, bs = "cs") + s(diameter, bs = "cs") + #co-variates
        s(interharvest_id, bs = "re") + s(plant, bs = "re"), #random effects
      data = shootdf,
      family = scat, #because residuals are very leptokurtic w/ gaussian
      method = "REML")

m_shoot_min_temp <- 
  gam(growth ~ 
        #cross-basis function for temperature
        s(Q_min_temp, L,
          bs = "cb",
          k = c(5, 7),
          xt = list(bs = "cr")
          ) +
        s(day_post, bs = "cs") + s(diameter, bs = "cs") + #co-variates
        s(interharvest_id, bs = "re") + s(plant, bs = "re"), #random effects
      data = shootdf,
      family = scat, #because residuals are very leptokurtic w/ gaussian
      method = "REML")

m_shoot_max_temp <- 
  gam(growth ~ 
        #cross-basis function for temperature
        s(Q_max_temp, L,
          bs = "cb",
          k = c(5, 7),
          xt = list(bs = "cr")
          ) +
        s(day_post, bs = "cs") + s(diameter, bs = "cs") + #co-variates
        s(interharvest_id, bs = "re") + s(plant, bs = "re"), #random effects
      data = shootdf,
      family = scat, #because residuals are very leptokurtic w/ gaussian
      method = "REML")


m_shoot_precip <- 
  gam(growth ~ 
        #cross-basis function for precipitation
        s(Q_precip, L,
          bs = "cb",
          k = c(5, 7),
          xt = list(bs = "cr")
          ) +
        s(day_post, bs = "cs") + s(diameter, bs = "cs") + #co-variates
        s(interharvest_id, bs = "re") + s(plant, bs = "re"), #random effects
      data = shootdf,
      family = scat, #because residuals are very leptokurtic w/ gaussian
      method = "REML")
```

```{r}
ICtab(m_shoot_temp, m_shoot_min_temp, m_shoot_max_temp, m_shoot_precip)
```

temperature models have the lowest AIC.  Min, max, mean all essentially interchangable.

# Mean Temperature model

```{r}
anova(m_shoot_temp)
```

Significant effects of lagged temperature, days post harvest, stem diameter, and plant ID.

# Minimum Temperature model

```{r}
anova(m_shoot_min_temp)
```

still significant effect of minimum temperature


# Maximum temperature model

```{r}
anova(m_shoot_max_temp)
```

Same, still significant.

# Precipitation model

```{r}
anova.gam(m_shoot_precip)
```

In this one, the co-variate `day_post` isn't significant. Odd...

# Plots

## Covariates:

Extract data from GAMs

```{r include=FALSE}
make_df <- function(m, elements = 2:3){
  pd <- plot.gam(m, seWithMean = TRUE)

  df <- map(pd[elements],
           ~{
             tibble(x = .x$x,
                    se = .x$se,
                    fit = .x$fit + coef(m)[1])
           }) %>%
    set_names(map(pd[elements], ~pluck(.x, "xlab"))) %>% 
    bind_rows(.id = "variable")

  return(df)
}

make_df_raw <- function(m, elements = 2:3){
  pd <- plot.gam(m)
  
  df <- map(pd[elements],
            ~{
              tibble(raw = .x$raw)
            }) %>% 
    set_names(map(pd[elements], ~.x$xlab)) %>% 
    bind_rows(.id = "variable")
  return(df)
}


covar_plot_data <- 
  list(m_shoot_min_temp, m_shoot_temp, m_shoot_precip) %>% 
  set_names("Minimum temp", "Mean temp", "Precipitation") %>% 
  map_dfr(make_df, .id = "model")

#raw values should be the same for all plots
covar_raw_data <-
  make_df_raw(m_shoot_min_temp)
```

Days post-harvest

```{r}
dph_plot <- 
  covar_plot_data %>% 
  filter(variable == "day_post") %>% 
  ggplot(aes(x = x, y = fit, color = model)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = fit - se, ymax = fit + se), fill = "grey", linetype = 0, alpha = 0.5) +
  geom_rug(data = covar_raw_data %>% filter(variable == "day_post"),
           aes(y = 0, x = raw),
           sides = "b",
           color = "black",
           alpha = 0.03) +
  scale_y_continuous(limits = c(0, 0.6)) +
  labs(x = "Days post harvest", y = "Shoot growth (cm/day)", color = "Model") +
  theme_bw()
```

```{r}
dia_plot <- 
  covar_plot_data %>% 
  filter(variable == "diameter") %>% 
  ggplot(aes(x = x, y = fit, color = model)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = fit - se, ymax = fit + se), fill = "grey", linetype = 0, alpha = 0.5) +
  geom_rug(data = covar_raw_data %>% filter(variable == "diameter"),
           aes(y = 0, x = raw),
           sides = "b",
           color = "black",
           alpha = 0.03) +
  scale_y_continuous(limits = c(0, 0.6)) +
  labs(x = "Stem Diameter (mm)", y = "Shoot growth (cm/day)", color = "Model") +
  theme_bw()
```


Shoots with larger diameters grow faster.  Shoot growth rates vary through time in a more complex manner with the fastest growth happening about 10 days post harvest and the slowest growth around 25 days post harvest.

Unclear why partial effect from precip model are always higher than temp model.  I double-checked and its not a coding error as far as I can tell.

```{r}
covars <-
  dia_plot + 
  (dph_plot +
     theme(axis.title.y = element_blank(),
           axis.text.y = element_blank(),
           axis.ticks.y = element_blank())) + 
  plot_layout(guides = "collect") + plot_annotation(tag_levels = "A")
```

```{r}
ggsave(here("figs", "shoot_covariates.png"), covars, width = 165, height = 80, units = "mm")
ggsave(here("figs", "figure 4.tiff"), covars, width = 165, height = 80, units = "mm")
```

## Cross-basis plots
### Generate data

```{r}
st_pd <- pred_shoots(Q = Q_temp, lag = 15, df = shootdf, colname = "temp_mean",
                     model = m_shoot_temp)
stmin_pd <- pred_shoots(Q = Q_min_temp, lag = 15, df = shootdf, colname = "temp_min",
                     model = m_shoot_min_temp)
stmax_pd <- pred_shoots(Q = Q_max_temp, lag = 15, df = shootdf, colname = "temp_max",
                     model = m_shoot_max_temp)
sp_pd <- pred_shoots(Q = Q_precip, lag = 15, df = shootdf, colname = "precip",
                     model = m_shoot_precip)
```

Uniform scale across plots:

```{r}
growth_lims <- c(min(st_pd$fitted, sp_pd$fitted, stmin_pd$fitted, stmax_pd$fitted),
                 max(st_pd$fitted, sp_pd$fitted, stmin_pd$fitted, stmax_pd$fitted))
```

### Mean Temperature cross-basis

Raster version:

```{r}
shoot_temp_raster <-
  ggplot(st_pd, aes(x = x, y = lag, z = fitted, fill = fitted)) +
  geom_raster(interpolate = TRUE) +
  geom_contour(color = "grey50", size = 0.4) +
  scale_fill_viridis_c("Shoot growth\n(cm/day)", option = "A", limits = growth_lims) + 
  scale_y_continuous("Lag (days)", expand = c(0,0)) + 
  scale_x_continuous("Temperature (ºC)", expand = c(0,0)) +
  theme(text = element_text(size = 12), aspect.ratio = 1)
shoot_temp_raster
# ggsave(here("figs", "shoot_temp_raster.png"), shoot_temp_raster)
```

### Min temperature cross-basis

```{r}
shoot_min_temp_raster <-
  ggplot(stmin_pd, aes(x = x, y = lag, z = fitted, fill = fitted)) +
  geom_raster(interpolate = TRUE) +
  geom_contour(color = "grey50", size = 0.4) +
  scale_fill_viridis_c("Shoot growth\n(cm/day)", option = "A", limits = growth_lims) + 
  scale_y_continuous("Lag (days)", expand = c(0,0)) + 
  scale_x_continuous("Temperature (ºC)", expand = c(0,0)) +
  theme(text = element_text(size = 12), aspect.ratio = 1)
shoot_min_temp_raster
```

### Max temperature cross-basis

```{r}
shoot_max_temp_raster <-
  ggplot(stmax_pd, aes(x = x, y = lag, z = fitted, fill = fitted)) +
  geom_raster(interpolate = TRUE) +
  geom_contour(color = "grey50", size = 0.4) +
  scale_fill_viridis_c("Shoot growth\n(cm/day)", option = "A", limits = growth_lims) + 
  scale_y_continuous("Lag (days)", expand = c(0,0)) + 
  scale_x_continuous("Temperature (ºC)", expand = c(0,0)) +
  theme(text = element_text(size = 12), aspect.ratio = 1)
shoot_max_temp_raster
```

### Precip cross-basis

```{r}
sp_pd %>% 
  filter(lag == 1) %>% 
  filter(fitted == max(fitted))

sp_pd %>% 
  filter(lag == 1) %>% 
  filter(x == min(x))

sp_pd %>% 
  filter(lag == 1) %>% 
  filter(fitted == min(fitted))

sp_pd %>% 
  # filter(lag == 1) %>% 
  filter(fitted == max(fitted))
```

Raster version:

```{r}
shoot_precip_raster <-
  ggplot(sp_pd, aes(x = x, y = lag, z = fitted, fill = fitted)) +
  geom_raster(interpolate = TRUE) +
  geom_contour(color = "grey50", size = 0.4) +
  scale_fill_viridis_c("Shoot growth\n(cm/day)", option = "A", limits = growth_lims) + 
  scale_y_continuous("Lag (days)", expand = c(0,0)) + 
  scale_x_continuous("Precipitation (mm)", expand = c(0,0)) +
  theme(text = element_text(size = 12), aspect.ratio = 1)
# ggsave(here("figs", "shoot_precip_raster.png"), shoot_precip_raster)
```

Combine raster plots
```{r}
shoot_cb <-
  shoot_min_temp_raster + shoot_temp_raster + shoot_precip_raster + guide_area() +
  plot_layout(guides = "collect") + 
  plot_annotation(tag_levels = "A") &
  guides(fill = guide_colorbar(title.position = "left"))
ggsave(here("figs", "shoot_crossbasis.png"), shoot_cb, width = 165, units = "mm")
ggsave(here("figs", "figure 3.eps"), shoot_cb, width = 165, units = "mm")
```