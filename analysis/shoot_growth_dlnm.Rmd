---
title: "Distributed Lag Model for Shoot Growth"
author: "Eric R. Scott"
date: "2020-01-15"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, paged.print=FALSE)
options(scipen = 4)
```

*Last compiled: `r Sys.Date()`*

# Packages

```{r packages, message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(conflicted)
library(mgcv)
library(dlnm)
library(glue)
library(colorspace)
library(patchwork)
library(bbmle)
library(visibly) #for ggplot figures from GAMs
library(lubridate)

conflict_prefer("filter", "dplyr")
conflict_prefer("here", "here")
conflict_prefer("lag", "dplyr")
conflict_prefer("select", "dplyr")

source(here("R", "crossbasis.r"))
```

# Goal

This analysis is based on Gasparrini A, Scheipl F, Armstrong B, Kenward MG (2017) A penalized framework for distributed lag non-linear models. Biometrics 73:938â€“948. doi: 10.1111/biom.12645.  Specifically, it is based on `ex1_01.int.R` provided in their code.  This "internal" method for distributed lag models takes full(?) advantage of built in features of `gam`s.

The goal is to model the effects of temperature and precipitation on plant growth allowing for variable shape through time (lag) and across values of the predictor using a two-dimensional smoothing function called a cross-basis function. In an ideal world, the penalized spline would be the shrinkage version (bs = "cs"), but that isn't available in the crossbasis smooth constructor provided by `dlnm`, so this uses regular penalized cubic regression splines.

# Read in Data

```{r}
shootdf <- read_rds(here("data", "cleaned", "shoots.rds"))
```

Variables I'll be using:

- `growth` (response): a linear growth rate in cm ($h_t - h_{t-1}$)
- `diameter` (co-variate): stem diameter in mm
- `day_post` (co-variate): number of days post-harvest.  Shoots are "re-set" every harvest
- `temp_*` (predictor): I'm using mean temperature lagged out to 14 days to make a cross-basis function
- `precip_*` (predictor): precipitation lagged out to 14 days
- `plant` (random effect): which plant was the shoot on
- `interharvest_id` (random effect): combination of field ID and which interharvest period it was.  Each field x interharvest period experienced a unique climate history because harvests were not synchronized between the two fields.

# Visual inspection

```{r}
ggplot(shootdf, aes(x=growth)) + geom_histogram(bins = 30)
```


# Distributed Lag Model: "internal" method

## Fit cross-basis GAMs

```{r}
m_shoot_temp_mean <- 
  gam(growth ~ 
        #cross-basis function for temperature
        s(Q_temp_mean, L,
          bs = "cb",
          k = c(10, 14),
          xt = list(bs = "cr")
          ) +
        s(day_post, bs = "cr") + s(diameter, k = 15, bs = "cr") + #co-variates
        s(interharvest_id, bs = "re") + s(plant, bs = "re"), #random effects
      data = shootdf,
      family = scat, #because residuals are very leptokurtic w/ gaussian
      gamma = 1.2,
      method = "REML")
gam.check(m_shoot_temp_mean)
```


```{r}
m_shoot_temp_min <- 
  gam(growth ~ 
        #cross-basis function for temperature
        s(Q_temp_min, L,
          bs = "cb",
          k = c(10, 14),
          xt = list(bs = "cr")
          ) +
        s(day_post, bs = "cr") + s(diameter, k = 15, bs = "cr") + #co-variates
        s(interharvest_id, bs = "re") + s(plant, bs = "re"), #random effects
      data = shootdf,
      family = scat, #because residuals are very leptokurtic w/ gaussian
      gamma = 1.2,
      method = "REML")
gam.check(m_shoot_temp_min)
```


```{r}
m_shoot_temp_max <- 
  gam(growth ~ 
        #cross-basis function for temperature
        s(Q_temp_max, L,
          bs = "cb",
          k = c(10, 14),
          xt = list(bs = "cr")
          ) +
        s(day_post, bs = "cr") + s(diameter, k = 15, bs = "cr") + #co-variates
        s(interharvest_id, bs = "re") + s(plant, bs = "re"), #random effects
      data = shootdf,
      family = scat, #because residuals are very leptokurtic w/ gaussian
      gamma = 1.2,
      method = "REML")
gam.check(m_shoot_temp_max)
```

```{r}
m_shoot_precip <- 
  gam(growth ~ 
        #cross-basis function for precipitation
        s(Q_precip, L,
          bs = "cb",
          k = c(10, 14),
          xt = list(bs = "cr")
          ) +
        s(day_post, bs = "cr") + s(diameter, k = 15, bs = "cr") + #co-variates
        s(interharvest_id, bs = "re") + s(plant, bs = "re"), #random effects
      data = shootdf,
      family = scat, #because residuals are very leptokurtic w/ gaussian
      gamma = 1.2,
      method = "REML")
gam.check(m_shoot_precip)
```


```{r}
ICtab(m_shoot_temp_mean, m_shoot_temp_min, m_shoot_temp_max, m_shoot_precip)
```

temperature models have the lowest AIC.  Min, max, mean all essentially interchangable.

# Mean Temperature model

```{r}
anova(m_shoot_temp_mean)
```

Significant effects of lagged temperature, days post harvest, stem diameter, and plant ID.

# Minimum Temperature model


```{r}
anova(m_shoot_temp_min)
```

still significant effect of minimum temperature


# Maximum temperature model


```{r}
anova(m_shoot_temp_max)
```

Same, still significant.

# Precipitation model

```{r}
anova.gam(m_shoot_precip)
```

In this one, the co-variate `day_post` isn't significant. Odd...

# Save Models

```{r}
write_rds(m_shoot_precip, here("analysis", "models",    "m_shoot_precip.rds"))
write_rds(m_shoot_temp_max, here("analysis", "models",  "m_shoot_temp_max.rds"))
write_rds(m_shoot_temp_mean, here("analysis", "models", "m_shoot_temp_mean.rds"))
write_rds(m_shoot_temp_min, here("analysis", "models",  "m_shoot_temp_min.rds"))
```

